<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-en="My Smart ekimina | Admin Dashboard" data-rw="My Smart ekimina | Ikibaho cy'Umuyobozi" data-fr="My Smart ekimina | Tableau de Bord Admin">My Smart ekimina | Admin Dashboard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css">
    <style>
        :root {
            --primary: #2E5BFF;
            --primary-dark: #1A3DB0;
            --secondary: #00D4AA;
            --success: #00C851;
            --warning: #ffbb33;
            --danger: #ff4444;
            --dark: #2E384D;
            --light: #F8F9FC;
            --gray: #B0BAC9;
            --gray-light: #EDF0F7;
            --gradient: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            --shadow: 0 10px 30px rgba(46, 91, 255, 0.1);
            --border-radius: 12px;
        }
        
        html {
            scroll-behavior: smooth;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            color: var(--dark);
            background-color: var(--light);
            display: flex;
            min-height: 100vh;
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            line-height: 1.6;
        }
        
        /* Sidebar */
        .sidebar {
            width: 250px;
            background: var(--dark);
            color: white;
            padding: 20px 0;
            height: 100vh;
            position: fixed;
            overflow-y: auto;
        }
        
        .logo {
            text-align: center;
            padding: 20px 10px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            margin-bottom: 20px;
        }
        
        .logo h2 {
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .logo span {
            color: var(--secondary);
        }
        
        .nav-menu {
            list-style: none;
            padding: 0 15px;
            margin-bottom: 60px;
        }
        
        .nav-menu li {
            margin-bottom: 5px;
        }
        
        .nav-menu a {
            display: flex;
            align-items: center;
            padding: 12px 15px;
            color: #ddd;
            text-decoration: none;
            border-radius: 5px;
            transition: all 0.3s;
        }
        
        .nav-menu a:hover, .nav-menu a.active {
            background: rgba(46, 91, 255, 0.2);
            color: white;
        }
        
        .nav-menu i {
            margin-right: 10px;
            width: 20px;
            text-align: center;
        }
        
        .user-info {
            position: absolute;
            bottom: 20px;
            width: 100%;
            padding: 10px 12px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--secondary);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 5px;
            font-weight: bold;
            font-size: 0.85rem;
            flex-shrink: 0;
            color: white;
        }
        
        .user-details h4 {
            font-size: 0.8rem;
            margin-bottom: 1px;
        }
        
        .user-details p {
            font-size: 0.7rem;
            color: #aaa;
        }
        
        /* Main Content */
        .main-content {
            flex: 1;
            margin-left: 250px;
            padding: 20px;
            padding-bottom: 100px;
            overflow-y: auto;
            max-height: 100vh;
            scroll-padding-top: 80px;
        }
        
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 15px;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .header h1 {
            color: var(--dark);
            font-size: 1.8rem;
        }
        
        .stats-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: var(--card-shadow);
            display: flex;
            align-items: center;
            justify-content: space-between;
            transition: transform 0.3s;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
        }
        
        .stat-info h3 {
            font-size: 2rem;
            color: var(--primary);
            margin-bottom: 5px;
        }
        
        .stat-info p {
            color: #777;
            font-size: 0.9rem;
        }
        
        .stat-icon {
            width: 60px;
            height: 60px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8rem;
        }
        
        .members-icon {
            background: rgba(46, 91, 255, 0.2);
            color: var(--primary);
        }
        
        .contribution-icon {
            background: rgba(0, 200, 136, 0.2);
            color: var(--success);
        }
        
        .loans-icon {
            background: rgba(255, 187, 51, 0.2);
            color: var(--warning);
        }
        
        .pending-icon {
            background: rgba(255, 68, 68, 0.2);
            color: var(--danger);
        }
        
        /* Dashboard Sections */
        .dashboard-section {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 30px;
            box-shadow: var(--card-shadow);
        }
        
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }
        
        .section-header h2 {
            color: var(--dark);
            font-size: 1.3rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .btn {
            padding: 8px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 5px;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background: var(--gradient);
            color: white;
        }
        
        .btn-success {
            background-color: var(--success);
            color: white;
        }
        
        .btn-warning {
            background-color: var(--warning);
            color: white;
        }
        
        .btn-danger {
            background-color: var(--danger);
            color: white;
        }
        
        .btn-secondary {
            background-color: white;
            color: var(--primary);
            border: 2px solid var(--primary);
            padding: 8px 15px;
        }
        
        .btn-secondary:hover {
            background-color: var(--primary);
            color: white;
        }
        
        /* Notification Center */
        .notification-form textarea {
            width: 100%;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            margin-bottom: 15px;
            resize: vertical;
            min-height: 100px;
        }
        
        .notification-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
        
        /* Members & Transactions Table */
        .table-container {
            overflow-x: auto;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        
        th {
            background-color: #f8f9fa;
            color: var(--dark);
            font-weight: 600;
        }
        
        /* Calendar */
        #calendar {
            margin-top: 15px;
        }
        
        .fc {
            font-size: 0.9rem;
        }
        
        .fc .fc-toolbar {
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 15px;
        }
        
        .fc .fc-toolbar.fc-header-toolbar {
            margin-bottom: 15px;
        }
        
        .fc-toolbar-chunk {
            display: flex;
            gap: 6px;
            align-items: center;
        }
        
        .fc .fc-button-group {
            gap: 4px;
        }
        
        .fc .fc-button-primary {
            background-color: var(--primary);
            border-color: var(--primary);
            padding: 6px 10px;
            font-size: 0.85rem;
        }
        
        .fc .fc-button-primary:not(:disabled):hover {
            background-color: var(--primary-dark);
        }
        
        .fc .fc-button-primary:not(:disabled).fc-button-active {
            background-color: var(--primary-dark);
            border-color: var(--primary-dark);
        }
        
        .fc .fc-button-primary:disabled {
            background-color: #ccc;
            border-color: #ccc;
            opacity: 0.6;
        }
        
        .fc .fc-daygrid-day.fc-day-other {
            background-color: transparent;
            color: var(--gray);
        }
        
        .fc .fc-daygrid-day:hover {
            background-color: var(--light);
        }
        
        tr:hover {
            background-color: #f9f9f9;
        }
        
        .status-badge {
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }
        
        .status-active {
            background: rgba(0, 200, 136, 0.2);
            color: var(--success);
        }
        
        .status-pending {
            background: rgba(255, 187, 51, 0.2);
            color: var(--warning);
        }
        
        .status-review {
            background: rgba(46, 91, 255, 0.2);
            color: var(--primary);
        }
        
        .status-overdue {
            background: rgba(255, 68, 68, 0.2);
            color: var(--danger);
        }
        
        .status-info {
            background: rgba(33, 150, 243, 0.2);
            color: #2196F3;
        }
        
        .action-buttons {
            display: flex;
            gap: 5px;
        }
        
        .action-btn {
            padding: 5px 10px;
            border-radius: 3px;
            border: none;
            cursor: pointer;
            font-size: 0.8rem;
        }
        
        .action-btn.approve {
            background: var(--success);
            color: white;
        }
        
        .action-btn.reject {
            background: var(--danger);
            color: white;
        }
        
        .action-btn.view {
            background: var(--primary);
            color: white;
        }

        .action-btn.edit {
            background: var(--warning);
            color: white;
        }

        .action-btn.delete {
            background: var(--danger);
            color: white;
        }
        
        /* Loan Types */
        .loan-types {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .loan-card {
            border: 1px solid #eee;
            border-radius: 8px;
            padding: 20px;
            transition: all 0.3s;
        }
        
        .loan-card:hover {
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        
        .loan-card h4 {
            margin-bottom: 10px;
            color: var(--dark);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .loan-card p {
            color: #666;
            font-size: 0.9rem;
            margin-bottom: 15px;
        }
        
        .loan-stats {
            display: flex;
            justify-content: space-between;
            font-size: 0.9rem;
            color: #777;
        }
        
        /* Calendar */
        #calendar {
            margin-top: 20px;
        }
        
        /* Link Creation */
        .link-section {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        .link-input {
            flex: 1;
            padding: 10px 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background: #f9f9f9;
        }
        
        .copy-btn {
            background: var(--dark);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
        }
        
        /* Contribution Info */
        .contribution-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background: #f9f9f9;
            border-radius: 8px;
            margin-top: 15px;
        }
        
        .contribution-amount {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--primary);
        }
        
        /* Tabs */
        .tabs {
            display: flex;
            border-bottom: 1px solid #ddd;
            margin-bottom: 20px;
        }
        
        .tab-btn {
            padding: 10px 20px;
            background: none;
            border: none;
            cursor: pointer;
            font-weight: 600;
            color: #777;
            border-bottom: 3px solid transparent;
        }
        
        .tab-btn.active {
            color: var(--primary);
            border-bottom: 3px solid var(--primary);
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* Responsive */
        @media (max-width: 992px) {
            .sidebar {
                width: 70px;
            }
            
            .sidebar .logo h2 span, 
            .sidebar .nav-menu a span,
            .sidebar .user-details {
                display: none;
            }
            
            .sidebar .logo h2 i {
                margin-right: 0;
            }
            
            .sidebar .nav-menu a {
                justify-content: center;
            }
            
            .sidebar .nav-menu i {
                margin-right: 0;
                font-size: 1.2rem;
            }
            
            .main-content {
                margin-left: 70px;
                padding-bottom: 110px;
            }
            
            footer {
                left: 70px !important;
            }
        }
        
        @media (max-width: 768px) {
            .stats-cards {
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            }
            
            .main-content {
                padding-bottom: 120px;
            }
            
            footer {
                left: 0 !important;
            }
            
            .loan-types {
                grid-template-columns: 1fr;
            }
        }

        /* Utility Classes */
        .btn-full-width {
            width: 100%;
        }

        .mt-15 {
            margin-top: 15px;
        }

        .mt-20 {
            margin-top: 20px;
        }

        .mt-25 {
            margin-top: 25px;
        }

        .mt-30 {
            margin-top: 30px;
        }

        .mb-15 {
            margin-bottom: 15px;
        }

        .mb-20 {
            margin-bottom: 20px;
        }

        .p-25 {
            padding: 25px;
        }

        .grid-2col {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
        }

        .bg-light {
            background: var(--light);
            border-radius: 12px;
        }

        .card-section {
            background: var(--light);
            padding: 25px;
            border-radius: 12px;
        }

        .section-title {
            margin-bottom: 20px;
            color: var(--dark);
            font-size: 1.2rem;
        }

        .form-input {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--gray-light);
            border-radius: 8px;
            font-size: 1rem;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .flex-row {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .flex-col {
            display: flex;
            flex-direction: column;
            gap: 12px;
            max-height: 400px;
            overflow-y: auto;
        }

        .contribution-item {
            padding: 15px;
            background: white;
            border-radius: 8px;
            border-left: 4px solid var(--success);
        }

        .contribution-item.pending {
            border-left-color: var(--warning);
        }

        .contribution-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .contribution-amount {
            font-weight: 600;
            color: var(--dark);
        }

        .contribution-method {
            font-size: 0.85rem;
            color: var(--gray);
            margin-top: 3px;
        }

        .contribution-date {
            text-align: right;
        }

        .contribution-date-text {
            font-size: 0.85rem;
            color: var(--gray);
        }

        .status-badge {
            display: inline-block;
            margin-top: 5px;
            padding: 4px 12px;
            background: rgba(0, 200, 81, 0.15);
            color: var(--success);
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .status-badge.pending {
            background: rgba(255, 187, 51, 0.15);
            color: var(--warning);
        }

        .info-box {
            margin-top: 15px;
            padding: 15px;
            background: #f0f8ff;
            border-radius: 8px;
        }

        .info-box-text {
            font-size: 0.9rem;
            margin-top: 5px;
        }

        .info-label {
            font-weight: 600;
            color: var(--primary);
            font-size: 1.1rem;
        }

        .table-container {
            margin-top: 30px;
        }

        .table-title {
            margin-bottom: 15px;
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--dark);
        }

        @media (max-width: 768px) {
            .grid-2col {
                grid-template-columns: 1fr;
            }
        }

        /* Additional Utility Classes */
        .d-flex {
            display: flex;
        }

        .gap-8 {
            gap: 8px;
        }

        .gap-20 {
            gap: 20px;
        }

        .flex-flex {
            font-size: 0.9rem;
        }

        .event-item {
            padding: 12px;
            border-left: 4px solid var(--primary);
            border-radius: 8px;
            background: linear-gradient(135deg, rgba(46, 91, 255, 0.1) 0%, rgba(0, 212, 170, 0.1) 100%);
        }

        .event-item.warning {
            border-left-color: var(--warning);
            background: linear-gradient(135deg, rgba(255, 187, 51, 0.1) 0%, rgba(255, 68, 68, 0.1) 100%);
        }

        .event-item.success {
            border-left-color: var(--success);
            background: linear-gradient(135deg, rgba(0, 200, 136, 0.1) 0%, rgba(46, 91, 255, 0.1) 100%);
        }

        .event-title {
            font-weight: 600;
            color: var(--dark);
            font-size: 0.95rem;
        }

        .event-date {
            font-size: 0.85rem;
            color: var(--gray);
            margin-top: 3px;
        }

        .text-description {
            color: #666;
        }

        .text-small {
            color: var(--gray);
            font-size: 0.85rem;
            margin-top: 5px;
        }

        .input-flex {
            flex: 1;
        }

        .btn-icon {
            padding: 8px 12px;
        }

        .form-display {
            display: block;
        }

        .form-hidden {
            display: none;
        }

        footer {
            position: fixed;
            bottom: 0;
            left: 250px;
            right: 0;
            background-color: var(--dark);
            color: white;
            padding: 18px 20px;
            text-align: center;
            font-size: 0.9rem;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            z-index: 10;
        }

        footer p {
            margin: 0;
            color: var(--gray);
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            align-items: start;
        }

        .calendar-events {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .events-section {
            margin-bottom: 15px;
            color: var(--dark);
        }

        @media (max-width: 768px) {
            .grid-2col {
                grid-template-columns: 1fr;
            }

            .calendar-grid {
                grid-template-columns: 1fr;
            }

            footer {
                left: 0;
            }
        }

        /* Calendar and Events Styles */
        .calendar-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            align-items: start;
        }

        #calendar {
            font-size: 0.9rem;
        }

        .events-section h4 {
            margin-bottom: 15px;
            color: var(--dark);
        }

        .events-container {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        /* Footer Styles */
        footer {
            position: fixed;
            bottom: 0;
            left: 250px;
            right: 0;
            background-color: var(--dark);
            color: white;
            padding: 18px 20px;
            text-align: center;
            font-size: 0.9rem;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            z-index: 99;
        }

        footer p {
            margin: 0;
            color: var(--gray);
        }

        .calendar-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .btn-download {
            background: var(--gray-light);
            color: var(--dark);
            border: 1px solid var(--gray-light);
        }

        .btn-download:hover {
            background: var(--gray);
            border-color: var(--gray);
        }
    </style>
</head>
<body>
    <!-- Sidebar -->
    <div class="sidebar">
        <div class="logo">
            <h2><i class="fas fa-link"></i> <span>My Smart ekimina</span></h2>
        </div>
        
        <ul class="nav-menu">
            <li><a href="#dashboard" class="active"><i class="fas fa-tachometer-alt"></i> <span>Dashboard</span></a></li>
            <li><a href="#notifications"><i class="fas fa-bell"></i> <span>Notifications</span></a></li>
            <li><a href="#members"><i class="fas fa-user-friends"></i> <span>Members</span></a></li>
            <li><a href="#loans"><i class="fas fa-hand-holding-usd"></i> <span>Loans</span></a></li>
            <li><a href="#transactions"><i class="fas fa-exchange-alt"></i> <span>Transactions</span></a></li>
            <li><a href="#my-contribution"><i class="fas fa-hand-holding-heart"></i> <span>My Contribution</span></a></li>
            <li><a href="user-dashboard.html"><i class="fas fa-user-circle"></i> <span>My Member Dashboard</span></a></li>
            <li><a href="#calendar-section"><i class="fas fa-calendar-alt"></i> <span>Calendar</span></a></li>
            <li><a href="#settings"><i class="fas fa-cog"></i> <span>Settings</span></a></li>
            <li><a href="#" id="logoutBtn" onclick="logout(); return false;"><i class="fas fa-sign-out-alt"></i> <span>Logout</span></a></li>
        </ul>
        
        <div class="user-info">
            <div class="user-avatar"><i class="fas fa-user-circle"></i></div>
            <div class="user-details">
                <h4>John Doe</h4>
                <p>Tontine Leader</p>
            </div>
        </div>
    </div>
    
    <!-- Main Content -->
    <div class="main-content">
        <!-- Header -->
        <div id="dashboard" class="header">
            <h1>My Smart ekimina</h1>
            <div class="header-actions">
                <button class="btn btn-secondary" onclick="window.location.href='user-dashboard.html'" style="margin-right: 10px;">
                    <i class="fas fa-user"></i> My Member Dashboard
                </button>
                <button class="btn btn-primary"><i class="fas fa-download"></i> Export Report</button>
            </div>
        </div>
        
        <!-- Stats Cards -->
        <div class="stats-cards">
            <div class="stat-card">
                <div class="stat-info">
                    <h3>24</h3>
                    <p>Active Members</p>
                </div>
                <div class="stat-icon members-icon">
                    <i class="fas fa-users"></i>
                </div>
            </div>
            
            <div class="stat-card">
                <div class="stat-info">
                    <h3>$2,850</h3>
                    <p>Total Contributions</p>
                </div>
                <div class="stat-icon contribution-icon">
                    <i class="fas fa-piggy-bank"></i>
                </div>
            </div>
            
            <div class="stat-card">
                <div class="stat-info">
                    <h3>5</h3>
                    <p>Active Loans</p>
                </div>
                <div class="stat-icon loans-icon">
                    <i class="fas fa-hand-holding-usd"></i>
                </div>
            </div>
            
            <div class="stat-card">
                <div class="stat-info">
                    <h3>3</h3>
                    <p>Pending Requests</p>
                </div>
                <div class="stat-icon pending-icon">
                    <i class="fas fa-clock"></i>
                </div>
            </div>
        </div>
        
        <!-- Notification Center -->
        <div id="notifications" class="dashboard-section">
            <div class="section-header">
                <h2><i class="fas fa-bullhorn"></i> Notification Center</h2>
            </div>
            
            <div class="notification-form">
                <textarea placeholder="Write a notification to send to all group members..."></textarea>
                <div class="notification-actions">
                    <button class="btn btn-primary"><i class="fas fa-paper-plane"></i> Send to All Members</button>
                    <button class="btn btn-success"><i class="fas fa-save"></i> Save Draft</button>
                </div>
            </div>
        </div>
        
        <!-- Members Section -->
        <div id="members" class="dashboard-section">
            <div class="tabs">
                <button class="tab-btn active" data-tab="active-members">Active Members</button>
                <button class="tab-btn" data-tab="pending-requests">Pending Requests (3)</button>
            </div>
            
            <!-- Active Members Tab -->
            <div id="active-members" class="tab-content active">
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Member Name</th>
                                <th>Email</th>
                                <th>Phone</th>
                                <th>Join Date</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Data will be populated by JavaScript -->
                            <tr>
                                <td colspan="6" style="text-align: center; padding: 40px; color: var(--gray);">
                                    <i class="fas fa-spinner fa-spin" style="font-size: 36px; margin-bottom: 10px;"></i>
                                    <p>Loading active members...</p>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- Pending Requests Tab -->
            <div id="pending-requests" class="tab-content">
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Applicant Name</th>
                                <th>Request Date</th>
                                <th>Contact Info</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>David Wilson</td>
                                <td>2023-10-05</td>
                                <td>david@email.com</td>
                                <td><span class="status-badge status-pending">Pending</span></td>
                                <td>
                                    <div class="action-buttons">
                                        <button class="action-btn approve"><i class="fas fa-check"></i> Approve</button>
                                        <button class="action-btn reject"><i class="fas fa-times"></i> Reject</button>
                                        <button class="action-btn view"><i class="fas fa-eye"></i></button>
                                    </div>
                                </td>
                            </tr>
                            <tr>
                                <td>Sarah Miller</td>
                                <td>2023-10-04</td>
                                <td>sarah@email.com</td>
                                <td><span class="status-badge status-pending">Pending</span></td>
                                <td>
                                    <div class="action-buttons">
                                        <button class="action-btn approve"><i class="fas fa-check"></i> Approve</button>
                                        <button class="action-btn reject"><i class="fas fa-times"></i> Reject</button>
                                        <button class="action-btn view"><i class="fas fa-eye"></i></button>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <!-- Loans Management Section -->
        <div id="loans" class="dashboard-section">
            <div class="section-header">
                <h2><i class="fas fa-hand-holding-usd"></i> Loan Requests & Status</h2>
                <div style="display: flex; gap: 10px;">
                    <button class="btn btn-primary"><i class="fas fa-plus"></i> New Loan</button>
                    <button class="btn btn-secondary" onclick="openLoanSettingsModal()"><i class="fas fa-cog"></i> Loan Settings</button>
                </div>
            </div>
            
            <div class="loan-types">
                <!-- Rapid Loans (30 days) -->
                <div class="loan-card">
                    <h4>Rapid Loans <span class="status-badge status-overdue">30 Days</span></h4>
                    <p>Short-term loans with quick approval for urgent needs. Must be repaid within 30 days.</p>
                    <div class="loan-stats">
                        <span id="rapidLoansActive">Active: 0</span>
                        <span id="rapidLoansPending">Pending: 0</span>
                    </div>
                    <button class="btn btn-warning btn-full-width mt-15" onclick="loadRapidLoans()">View Rapid Loans</button>
                </div>
                
                <!-- Long Loans (Tontine Cycle) -->
                <div class="loan-card">
                    <h4>Long Loans <span class="status-badge status-info">Full Cycle</span></h4>
                    <p>Extended loans that must be repaid within the tontine cycle period. Maximum flexibility within cycle duration.</p>
                    <div class="loan-stats">
                        <span id="longLoansActive">Active: 0</span>
                        <span id="longLoansTotal">Total: 0 RWF</span>
                    </div>
                    <button class="btn btn-info btn-full-width mt-15" style="background-color: #2196F3; border-color: #2196F3; color: white;" onclick="loadLongLoans()">View Long Loans</button>
                </div>
                
                <!-- Confirmed Loans -->
                <div class="loan-card">
                    <h4>Confirmed Loans <span class="status-badge status-active">Active</span></h4>
                    <p>Approved and active loans with repayment schedules.</p>
                    <div class="loan-stats">
                        <span id="confirmedLoansCount">Active: 0</span>
                        <span id="confirmedLoansTotal">Total: 0 RWF</span>
                    </div>
                    <button class="btn btn-success btn-full-width mt-15" onclick="loadConfirmedLoans()">Manage Loans</button>
                </div>
                
                <!-- Under Review Loans -->
                <div class="loan-card">
                    <h4>Under Review <span class="status-badge status-review">Review</span></h4>
                    <p>Loan applications currently being evaluated by the committee.</p>
                    <div class="loan-stats">
                        <span id="reviewLoansCount">Applications: 0</span>
                        <span id="reviewLoansAvg">Avg. Amount: 0 RWF</span>
                    </div>
                    <button class="btn btn-primary btn-full-width mt-15" onclick="loadUnderReviewLoans()">Review Applications</button>
                </div>
            </div>
            
            <div class="table-container">
                <h3 class="table-title">Paid Loans</h3>
                <table>
                    <thead>
                        <tr>
                            <th>Member</th>
                            <th>Loan Type</th>
                            <th>Amount</th>
                            <th>Payment Date</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="paidLoansTableBody">
                        <tr>
                            <td colspan="6" style="text-align: center; padding: 40px; color: var(--gray);">
                                <i class="fas fa-spinner fa-spin" style="font-size: 36px; margin-bottom: 10px;"></i>
                                <p>Loading paid loans...</p>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Tontine Contribution Summary -->
        <div class="dashboard-section">
            <div class="section-header">
                <h2><i class="fas fa-users"></i> Tontine Contribution Summary</h2>
                <button class="btn btn-primary" onclick="loadContributionSummary()"><i class="fas fa-sync-alt"></i> Refresh</button>
            </div>
            
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Member Name</th>
                            <th>Total Contribution (RWF)</th>
                            <th>Total Loans (RWF)</th>
                            <th>Net Contribution (RWF)</th>
                        </tr>
                    </thead>
                    <tbody id="contributionSummaryTableBody">
                        <tr>
                            <td colspan="4" style="text-align: center; padding: 40px; color: var(--gray);">
                                <i class="fas fa-spinner fa-spin" style="font-size: 36px; margin-bottom: 10px;"></i>
                                <p>Loading contribution summary...</p>
                            </td>
                        </tr>
                    </tbody>
                    <tfoot id="contributionSummaryFooter">
                        <tr style="background: var(--gray-light); font-weight: bold; border-top: 2px solid #ddd;">
                            <td style="padding: 15px;">TOTAL</td>
                            <td id="totalContribution" style="padding: 15px; text-align: right;">0 RWF</td>
                            <td id="totalLoans" style="padding: 15px; text-align: right;">0 RWF</td>
                            <td id="totalNetContribution" style="padding: 15px; text-align: right;">0 RWF</td>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>
        
        <!-- Transactions & Contributions -->
        <div id="transactions" class="dashboard-section">
            <div class="section-header">
                <h2><i class="fas fa-exchange-alt"></i> Recent Transactions</h2>
                <button class="btn btn-primary" onclick="loadTransactions()"><i class="fas fa-sync-alt"></i> Refresh</button>
            </div>
            
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Member</th>
                            <th>Type</th>
                            <th>Amount</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="transactionsTableBody">
                        <tr>
                            <td colspan="5" style="text-align: center; padding: 40px; color: var(--gray);">
                                <i class="fas fa-spinner fa-spin" style="font-size: 36px; margin-bottom: 10px;"></i>
                                <p>Loading transactions...</p>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
            
            <!-- Leader's Contribution -->
            <div class="contribution-info">
                <div>
                    <h4>Your Total Contribution</h4>
                    <p id="lastContributionText">Last contribution: Loading...</p>
                </div>
                <div class="contribution-amount" id="totalContributionAmount">--</div>
            </div>
        </div>
        
        <!-- Payment Requests Section -->
        <div id="payment-requests" class="dashboard-section">
            <div class="section-header">
                <h2><i class="fas fa-credit-card"></i> <span data-en="Payment Requests" data-rw="Ibiryano Byo Kwishyura" data-fr="Demandes de Paiement">Payment Requests</span></h2>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <span class="status-badge pending" id="paymentRequestCount" style="font-size: 0.9rem; padding: 5px 10px;">0</span>
                    <button class="btn btn-secondary" onclick="loadPaymentRequests()" style="padding: 8px 12px; font-size: 0.9rem;">
                        <i class="fas fa-sync-alt"></i> Refresh
                    </button>
                </div>
            </div>
            
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th data-en="Member" data-rw="Uyoboke" data-fr="Membre">Member</th>
                            <th data-en="Amount" data-rw="Amafaranga" data-fr="Montant">Amount</th>
                            <th data-en="Method" data-rw="Uburyo" data-fr="Méthode">Method</th>
                            <th data-en="Receipt" data-rw="Resi" data-fr="Reçu">Receipt</th>
                            <th data-en="Submitted" data-rw="Ohereza" data-fr="Soumis">Submitted</th>
                            <th data-en="Status" data-rw="Ubwoko" data-fr="Statut">Status</th>
                            <th data-en="Actions" data-rw="Imibare" data-fr="Actions">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="paymentRequestsTableBody">
                        <tr>
                            <td colspan="7" style="text-align: center; padding: 40px; color: var(--gray);">
                                <i class="fas fa-spinner fa-spin" style="font-size: 36px; margin-bottom: 10px;"></i>
                                <p data-en="Loading payment requests..." data-rw="Gutanga ibiryano..." data-fr="Chargement des demandes de paiement...">Loading payment requests...</p>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Loan Payment Receipts Section -->
        <div id="loan-repayments" class="dashboard-section">
            <div class="section-header">
                <h2><i class="fas fa-file-invoice-dollar"></i> Loan Repayment Approvals</h2>
                <p style="color: var(--gray); margin-top: 5px;">Review and approve loan payment receipts submitted by members</p>
            </div>
            
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Member</th>
                            <th>Loan Amount</th>
                            <th>Payment Date</th>
                            <th>Receipt Status</th>
                            <th>Submission Date</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="paymentReceiptsTableBody">
                        <tr>
                            <td colspan="6" style="text-align: center; padding: 40px; color: var(--gray);">
                                <i class="fas fa-spinner fa-spin" style="font-size: 36px; margin-bottom: 10px;"></i>
                                <p>Loading payment receipts...</p>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- Link Creation & Calendar -->
        <div class="grid-2col">
            <!-- Link Creation -->
            <div class="dashboard-section">
                <div class="section-header">
                    <h2><i class="fas fa-link"></i> Invite New Members</h2>
                </div>
                
                <p class="mb-15 text-description">Create a unique link to invite new members to join your tontine group.</p>
                
                <div class="link-section">
                    <input type="text" class="link-input" value="https://mysmartekimina.com/join/group-abc123" readonly title="Group invitation link" placeholder="Your invitation link will appear here">
                    <button class="copy-btn" id="copy-link"><i class="fas fa-copy"></i> Copy</button>
                </div>
                
                <div class="mt-20">
                    <button class="btn btn-success btn-full-width"><i class="fas fa-qrcode"></i> Generate QR Code</button>
                </div>
                
                <div class="info-box">
                    <h4><i class="fas fa-info-circle"></i> Note</h4>
                    <p class="info-box-text">New members can also request to join directly without a link. You can approve them in the "Pending Requests" tab.</p>
                </div>
            </div>
            
            <!-- My Own Contribution Section -->
            <div id="my-contribution" class="dashboard-section">
                <div class="section-header">
                    <h2><i class="fas fa-hand-holding-heart"></i> My Own Contribution</h2>
                </div>
                
                <div class="grid-2col">
                    <!-- Contribution Form -->
                    <div class="card-section">
                        <h3 class="section-title">Make a Contribution</h3>
                        
                        <div class="form-group">
                            <label data-en="Contribution Amount (RWF)" data-rw="Amafaranga y'Uruhare (RWF)" data-fr="Montant de la Contribution (RWF)">Contribution Amount (RWF)</label>
                            <div class="flex-row">
                                <span class="info-label">RWF</span>
                                <input type="number" id="leaderContributionAmount" placeholder="Enter amount" min="1000" step="1000" class="form-input input-flex">
                            </div>
                            <small class="text-small" data-en="Minimum: 10,000 RWF" data-rw="Amafaranga make: 10,000 RWF" data-fr="Minimum: 10,000 RWF">Minimum: 10,000 RWF</small>
                        </div>
                        
                        <div class="form-group mt-20">
                            <label for="leaderPaymentMethod" data-en="Payment Method" data-rw="Uburyo bwo Kwishyura" data-fr="Méthode de Paiement">Payment Method</label>
                            <select id="leaderPaymentMethod" class="form-input" title="Select payment method">
                                <option value="mobile" data-en="Mobile Money" data-rw="Amafaranga ya Telefone" data-fr="Mobile Money">Mobile Money</option>
                                <option value="bank" data-en="Bank Transfer" data-rw="Kohereza ku Banki" data-fr="Virement Bancaire">Bank Transfer</option>
                                <option value="cash" data-en="Cash" data-rw="Amafaranga" data-fr="Espèces">Cash</option>
                            </select>
                        </div>
                        
                        <div class="form-group mt-20 form-display" id="leaderMobileNumberField">
                            <label data-en="Mobile Number" data-rw="Numero ya Telefone" data-fr="Numéro de Mobile">Mobile Number</label>
                            <input type="tel" id="leaderMobileNumber" placeholder="0781234567" class="form-input">
                        </div>
                        
                        <div class="form-group mt-20 form-hidden" id="leaderBankDetailsField">
                            <label data-en="Bank Account Details" data-rw="Amakuru ya Konti ya Banki" data-fr="Détails du Compte Bancaire">Bank Account Details</label>
                            <textarea id="leaderBankDetails" rows="3" placeholder="Account number, bank name, etc." data-placeholder-en="Account number, bank name, etc." data-placeholder-rw="Numero ya konti, izina ry'banki, n'ibindi" data-placeholder-fr="Numéro de compte, nom de banque, etc." class="form-input"></textarea>
                        </div>
                        
                        <button class="btn btn-primary btn-full-width mt-25" onclick="processLeaderContribution()" data-en="Pay Now" data-rw="Shyira Noneho" data-fr="Payer Maintenant">Pay Now</button>
                    </div>
                    
                    <!-- Contribution History -->
                    <div class="card-section">
                        <h3 class="section-title">My Contribution History</h3>
                        
                        <div class="flex-col">
                            <div class="contribution-item">
                                <div class="contribution-header">
                                    <div>
                                        <div class="contribution-amount">50,000 RWF</div>
                                        <div class="contribution-method" data-en="Mobile Money" data-rw="Amafaranga ya Telefone" data-fr="Mobile Money">Mobile Money</div>
                                    </div>
                                    <div class="contribution-date">
                                        <div class="contribution-date-text">Dec 1, 2023</div>
                                        <span class="status-badge" data-en="Paid" data-rw="Yishyuye" data-fr="Payé">Paid</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="contribution-item">
                                <div class="contribution-header">
                                    <div>
                                        <div class="contribution-amount">50,000 RWF</div>
                                        <div class="contribution-method" data-en="Bank Transfer" data-rw="Kohereza ku Banki" data-fr="Virement Bancaire">Bank Transfer</div>
                                    </div>
                                    <div class="contribution-date">
                                        <div class="contribution-date-text">Nov 15, 2023</div>
                                        <span class="status-badge" data-en="Paid" data-rw="Yishyuye" data-fr="Payé">Paid</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="contribution-item">
                                <div class="contribution-header">
                                    <div>
                                        <div class="contribution-amount">50,000 RWF</div>
                                        <div class="contribution-method" data-en="Cash" data-rw="Amafaranga" data-fr="Espèces">Cash</div>
                                    </div>
                                    <div class="contribution-date">
                                        <div class="contribution-date-text">Nov 1, 2023</div>
                                        <span class="status-badge" data-en="Paid" data-rw="Yishyuye" data-fr="Payé">Paid</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="contribution-item pending">
                                <div class="contribution-header">
                                    <div>
                                        <div class="contribution-amount">50,000 RWF</div>
                                        <div class="contribution-method" data-en="Mobile Money" data-rw="Amafaranga ya Telefone" data-fr="Mobile Money">Mobile Money</div>
                                    </div>
                                    <div class="contribution-date">
                                        <div class="contribution-date-text">Today</div>
                                        <span class="status-badge pending" data-en="Pending" data-rw="Bitegereje" data-fr="En Attente">Pending</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Calendar -->
            <div id="calendar-section" class="dashboard-section">
                <div class="section-header">
                    <h2><i class="fas fa-calendar-alt"></i> Tontine Calendar</h2>
                    <div class="d-flex gap-8">
                        <button class="btn btn-primary btn-icon" title="Add event"><i class="fas fa-plus"></i></button>
                        <button class="btn btn-secondary btn-icon btn-download" title="Download calendar"><i class="fas fa-download"></i></button>
                    </div>
                </div>
                
                <div class="calendar-grid">
                    <div>
                        <div id="calendar"></div>
                    </div>
                    
                    <div class="events-section">
                        <h4>📅 <span data-en="Upcoming Events" data-rw="Ibirori Bitandukanye" data-fr="Événements à Venir">Upcoming Events</span></h4>
                        <div class="events-container">
                            <div class="event-item">
                                <div class="event-title">Monthly Meeting</div>
                                <div class="event-date">Oct 15, 2023</div>
                            </div>
                            
                            <div class="event-item warning">
                                <div class="event-title">Contribution Deadline</div>
                                <div class="event-date">Oct 20, 2023</div>
                            </div>
                            
                            <div class="event-item success">
                                <div class="event-title">Loan Committee Meeting</div>
                                <div class="event-date">Oct 25, 2023</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Footer -->
    <footer>
        <p>
            <span data-en="© 2025 My Smart ekimina-a product of cooloff company ltd. All rights reserved." data-rw="© 2025 My Smart ekimina-ikintu ky'isosiyete ya cooloff Ltd. Uburenganzira bwose buzemwa." data-fr="© 2025 My Smart ekimina-un produit de cooloff company ltd. Tous les droits réservés.">© 2025 My Smart ekimina-a product of cooloff company ltd. All rights reserved.</span>
        </p>
    </footer>
    
    <!-- Define logout function FIRST so onclick can find it -->
    <script>
        // Logout function - MUST be defined first for onclick attribute
        function logout() {
            console.log('Logout function called');
            try {
                if (confirm('Are you sure you want to logout?')) {
                    console.log('User confirmed logout');
                    
                    // Clear tokens and user data
                    localStorage.removeItem('authToken');
                    localStorage.removeItem('user');
                    
                    console.log('Tokens cleared, redirecting to login');
                    
                    // Redirect to login page
                    window.location.href = 'login.html';
                }
            } catch (error) {
                console.error('Logout error:', error);
                alert('Logout failed: ' + error.message);
            }
            return false; // Prevent default action
        }
    </script>
    
    <!-- API Configuration -->
    <script src="js/api.js"></script>
    <script src="js/integration-helper.js"></script>
    <script src="js/app-init.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js"></script>
    <script>
        // Global variables
        let currentLanguage = 'en';
        let currentGroupId = null;  // Store the current user's group ID

        function switchLanguage(lang) {
            currentLanguage = lang;
            
            // Update all elements with data attributes
            document.querySelectorAll('[data-en], [data-rw], [data-fr]').forEach(element => {
                const text = element.getAttribute(`data-${lang}`);
                if (text) {
                    element.textContent = text;
                }
            });
            
            // Update active language button
            document.querySelectorAll('.language-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.lang === lang) {
                    btn.classList.add('active');
                }
            });
            
            // Save language preference
            localStorage.setItem('preferredLanguage', lang);
        }

        // Load and display user data
        async function loadUserData() {
            const user = TokenManager.getUser();
            if (!user) {
                window.location.href = 'login.html';
                return;
            }
            
            // Check if user is a group leader
            if (user.role !== 'group_leader' && user.role !== 'site_admin') {
                alert('Access denied. Only group leaders can access this dashboard.');
                window.location.href = 'login.html';
                return;
            }
            
            // Check if user has any approved groups (if they're a group leader)
            if (user.role === 'group_leader') {
                try {
                    const groupsData = await GroupsAPI.getAll();
                    const approvedGroups = groupsData.groups?.filter(g => g.status === 'active') || [];
                    
                    if (approvedGroups.length === 0) {
                        // No approved groups yet, redirect to pending page
                        alert('Your tontine is still pending approval from the site administrator. You will be notified when it is approved.');
                        window.location.href = 'pending-approval.html';
                        return;
                    }
                } catch (error) {
                    console.error('Error checking group status:', error);
                    // Continue to load dashboard anyway
                }
            }
            
            // Update user name in sidebar
            const userName = `${user.firstName || ''} ${user.lastName || ''}`.trim() || user.email || 'User';
            const userNameEl = document.querySelector('.user-details h4');
            if (userNameEl) {
                userNameEl.textContent = userName;
            }
            
            // Update user role
            const userRoleEl = document.querySelector('.user-details p');
            if (userRoleEl && user.role) {
                const roleDisplay = user.role === 'site_admin' ? 'Site Administrator' : 
                                   user.role === 'group_leader' ? 'Tontine Leader' : 'Member';
                userRoleEl.textContent = roleDisplay;
            }
            
            // Update user avatar initials
            const initials = getUserInitials(userName);
            const userAvatar = document.querySelector('.user-avatar i');
            if (userAvatar) {
                userAvatar.parentElement.innerHTML = `<div style="display: flex; align-items: center; justify-content: center; width: 40px; height: 40px; background: var(--primary); color: white; border-radius: 50%; font-weight: bold;">${initials}</div>`;
            }
        }
        
        // Get user initials from name
        function getUserInitials(name) {
            const parts = name.trim().split(' ');
            if (parts.length >= 2) {
                return (parts[0][0] + parts[parts.length - 1][0]).toUpperCase();
            } else if (parts.length === 1 && parts[0].length > 0) {
                return parts[0].substring(0, 2).toUpperCase();
            }
            return 'U';
        }

        // Load pending membership requests from backend
        async function loadPendingRequests() {
            console.log('=== Loading pending requests from backend ===');
            
            try {
                const user = TokenManager.getUser();
                if (!user) {
                    console.error('No user found');
                    return;
                }
                
                console.log('Current user:', user.email, 'Role:', user.role, 'ID:', user.id);
                
                // Get ALL groups to find which one this user leads
                const groupsResponse = await GroupsAPI.getAll();
                console.log('✅ All groups response:', groupsResponse);
                console.log('Groups array:', groupsResponse.groups);
                
                if (!groupsResponse.groups || !Array.isArray(groupsResponse.groups)) {
                    console.error('❌ No groups array in response');
                    populatePendingRequestsTable([]);
                    return;
                }
                
                // Find groups where this user is the leader
                const leaderGroups = groupsResponse.groups.filter(g => {
                    console.log(`Checking group ${g.name}: leader_id=${g.leader_id}, user.id=${user.id}, status=${g.status}`);
                    return g.leader_id === user.id;
                });
                
                console.log('✅ Leader groups found:', leaderGroups.length);
                console.log('Leader groups details:', leaderGroups);
                
                if (leaderGroups.length === 0) {
                    console.log('⚠️ No groups found where user is leader');
                    populatePendingRequestsTable([]);
                    return;
                }
                
                const groupId = leaderGroups[0].id;
                console.log('📋 Using group ID:', groupId, 'Group name:', leaderGroups[0].name);
                
                // Store group ID globally for other functions to use
                currentGroupId = groupId;
                
                // Also store in localStorage for persistence
                localStorage.setItem('userGroup', groupId);
                
                // Fetch pending membership requests for this group
                const response = await GroupsAPI.getPendingRequests(groupId);
                console.log('✅ Pending requests API response:', response);
                
                if (response.pendingRequests && Array.isArray(response.pendingRequests)) {
                    console.log(`✅ Found ${response.pendingRequests.length} pending membership requests`);
                    console.log('Pending requests data:', response.pendingRequests);
                    
                    // Update pending requests count in tab button
                    const tabBtn = document.querySelector('[data-tab="pending-requests"]');
                    if (tabBtn) {
                        tabBtn.textContent = `Pending Requests (${response.pendingRequests.length})`;
                        console.log('✅ Updated tab button count');
                    }
                    
                    // Update stats card
                    const pendingCountEl = document.querySelector('.stat-card:nth-child(3) h3');
                    if (pendingCountEl) {
                        pendingCountEl.textContent = response.pendingRequests.length;
                        console.log('✅ Updated stats card count');
                    }
                    
                    // Populate the pending requests table
                    populatePendingRequestsTable(response.pendingRequests);
                } else {
                    console.warn('⚠️ No pending requests array in response');
                    console.log('Response structure:', response);
                    populatePendingRequestsTable([]);
                }
            } catch (error) {
                console.error('❌ Error loading pending requests:', error);
                console.error('Error details:', {
                    message: error.message,
                    stack: error.stack,
                    response: error.response
                });
                populatePendingRequestsTable([]);
                
                // Show error in table
                const tbody = document.querySelector('#pending-requests table tbody');
                if (tbody) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="5" style="text-align: center; padding: 40px; color: var(--danger);">
                                <i class="fas fa-exclamation-circle" style="font-size: 36px; margin-bottom: 10px;"></i>
                                <p>Failed to load pending requests: ${error.message}</p>
                                <p style="font-size: 0.9rem;">Please refresh the page or check your connection.</p>
                                <button class="btn btn-primary" onclick="loadPendingRequests()" style="margin-top: 15px;">
                                    <i class="fas fa-sync-alt"></i> Retry
                                </button>
                            </td>
                        </tr>
                    `;
                }
            }
            console.log('=== Load pending requests complete ===');
        }

        // Load active members from backend
        async function loadActiveMembers() {
            console.log('=== Loading active members from backend ===');
            
            try {
                const user = TokenManager.getUser();
                if (!user) {
                    console.error('No user found');
                    return;
                }
                
                console.log('Current user:', user.email, 'Role:', user.role, 'ID:', user.id);
                
                // Get ALL groups to find which one this user leads
                const groupsResponse = await GroupsAPI.getAll();
                console.log('✅ All groups response:', groupsResponse);
                
                if (!groupsResponse.groups || !Array.isArray(groupsResponse.groups)) {
                    console.error('❌ No groups array in response');
                    populateActiveMembersTable([]);
                    return;
                }
                
                // Find groups where this user is the leader
                const leaderGroups = groupsResponse.groups.filter(g => g.leader_id === user.id);
                
                console.log('✅ Leader groups found:', leaderGroups.length);
                
                if (leaderGroups.length === 0) {
                    console.log('⚠️ No groups found where user is leader');
                    populateActiveMembersTable([]);
                    return;
                }
                
                const groupId = leaderGroups[0].id;
                console.log('📋 Using group:', leaderGroups[0].name, 'ID:', groupId);
                
                // Store group ID globally for other functions to use
                currentGroupId = groupId;
                
                // Try multiple approaches to get member details
                let activeMembers = [];
                
                // Approach 1: Try dedicated active members endpoint
                try {
                    console.log('Trying getActiveMembers() endpoint...');
                    const activeMembersResponse = await GroupsAPI.getActiveMembers(groupId);
                    console.log('✅ Active members response:', activeMembersResponse);
                    console.log('Response type:', typeof activeMembersResponse);
                    console.log('Response keys:', Object.keys(activeMembersResponse || {}));
                    
                    if (activeMembersResponse.members && Array.isArray(activeMembersResponse.members)) {
                        activeMembers = activeMembersResponse.members;
                        console.log(`✅ Found ${activeMembers.length} active members from dedicated endpoint`);
                        console.log('Sample member:', activeMembers[0]);
                    } else if (Array.isArray(activeMembersResponse)) {
                        // Backend might return array directly
                        activeMembers = activeMembersResponse;
                        console.log(`✅ Found ${activeMembers.length} active members (direct array) from dedicated endpoint`);
                        console.log('Sample member:', activeMembers[0]);
                    } else {
                        console.log('⚠️ No members array found in response structure');
                    }
                } catch (error) {
                    console.warn('⚠️ getActiveMembers failed:', error.message);
                    console.warn('Error details:', error);
                }
                
                // Approach 2: Try getMembers endpoint (all members)
                if (activeMembers.length === 0) {
                    try {
                        console.log('Trying getMembers() endpoint...');
                        const membersResponse = await GroupsAPI.getMembers(groupId);
                        console.log('✅ Members response:', membersResponse);
                        console.log('Response type:', typeof membersResponse);
                        console.log('Response keys:', Object.keys(membersResponse || {}));
                        
                        let allMembers = [];
                        if (membersResponse.members && Array.isArray(membersResponse.members)) {
                            allMembers = membersResponse.members;
                        } else if (Array.isArray(membersResponse)) {
                            allMembers = membersResponse;
                        }
                        
                        if (allMembers.length > 0) {
                            console.log('All members data:', allMembers);
                            console.log('Member statuses:', allMembers.map(m => ({
                                id: m.user_id || m.id,
                                status: m.status,
                                name: m.user?.first_name || m.first_name || m.name || 'Unknown'
                            })));
                            
                            // Filter for approved members
                            activeMembers = allMembers.filter(m => m.status === 'approved');
                            console.log(`✅ Found ${activeMembers.length} approved members from getMembers (filtered from ${allMembers.length} total)`);
                            
                            // If no approved found, show all non-pending members (some backends might not use 'approved' status)
                            if (activeMembers.length === 0) {
                                console.log('⚠️ No "approved" status found, trying alternative statuses...');
                                activeMembers = allMembers.filter(m => m.status !== 'pending' && m.status !== 'rejected');
                                console.log(`✅ Found ${activeMembers.length} members using alternative status filter`);
                            }
                            
                            if (activeMembers.length > 0) {
                                console.log('Sample member:', activeMembers[0]);
                            }
                        } else {
                            console.log('⚠️ No members array found in response structure');
                        }
                    } catch (error) {
                        console.warn('⚠️ getMembers failed:', error.message);
                        console.warn('Error details:', error);
                    }
                }
                
                // Approach 3: Try getById for detailed group info
                if (activeMembers.length === 0) {
                    try {
                        console.log('Trying getById() endpoint...');
                        const detailedGroup = await GroupsAPI.getById(groupId);
                        console.log('✅ Detailed group data:', detailedGroup);
                        console.log('Response type:', typeof detailedGroup);
                        console.log('Response keys:', Object.keys(detailedGroup || {}));
                        
                        const group = detailedGroup.group || detailedGroup;
                        console.log('Group object:', group);
                        console.log('Group keys:', Object.keys(group || {}));
                        
                        if (group.members && Array.isArray(group.members)) {
                            console.log('Members statuses:', group.members.map(m => ({id: m.user_id || m.id, status: m.status})));
                            
                            activeMembers = group.members.filter(m => m.status === 'approved');
                            console.log(`✅ Found ${activeMembers.length} approved members from getById (filtered from ${group.members.length} total)`);
                            
                            // If no approved found, try alternative statuses
                            if (activeMembers.length === 0) {
                                console.log('⚠️ No "approved" status found, trying alternative statuses...');
                                activeMembers = group.members.filter(m => m.status !== 'pending' && m.status !== 'rejected');
                                console.log(`✅ Found ${activeMembers.length} members using alternative status filter`);
                            }
                            
                            if (activeMembers.length > 0) {
                                console.log('Sample member:', activeMembers[0]);
                            }
                        } else {
                            console.log('⚠️ No members array found in group object');
                        }
                    } catch (error) {
                        console.warn('⚠️ getById failed:', error.message);
                        console.warn('Error details:', error);
                    }
                }
                
                // Approach 4: If no members from any endpoint, try to get from the group data directly
                if (activeMembers.length === 0 && leaderGroups[0].members) {
                    console.log('Trying to use members from getAll() response...');
                    console.log('Group members array:', leaderGroups[0].members);
                    console.log('Members count:', leaderGroups[0].members.length);
                    console.log('All members statuses:', leaderGroups[0].members.map(m => ({id: m.user_id || m.id, status: m.status})));
                    
                    activeMembers = leaderGroups[0].members.filter(m => m.status === 'approved');
                    console.log(`✅ Found ${activeMembers.length} approved members from getAll (filtered from ${leaderGroups[0].members.length} total)`);
                    
                    // If no approved found, try alternative statuses
                    if (activeMembers.length === 0) {
                        console.log('⚠️ No "approved" status found, trying alternative statuses...');
                        activeMembers = leaderGroups[0].members.filter(m => m.status !== 'pending' && m.status !== 'rejected');
                        console.log(`✅ Found ${activeMembers.length} members using alternative status filter`);
                    }
                    
                    if (activeMembers.length > 0) {
                        console.log('Sample member:', activeMembers[0]);
                    }
                } else if (activeMembers.length === 0) {
                    console.log('⚠️ No members array in getAll() response either');
                    console.log('Leader group object:', leaderGroups[0]);
                }
                
                console.log('Final active members data:', activeMembers);
                
                // CRITICAL: Double-check that we only have approved members
                let onlyApproved = activeMembers.filter(m => m.status === 'approved');
                
                // If no approved members found with that status, try alternative approach
                if (onlyApproved.length === 0 && activeMembers.length > 0) {
                    console.log('⚠️ No members with "approved" status, checking available statuses...');
                    console.log('Available member statuses:', [...new Set(activeMembers.map(m => m.status))]);
                    
                    // Show all non-pending, non-rejected members
                    onlyApproved = activeMembers.filter(m => m.status !== 'pending' && m.status !== 'rejected');
                    console.log(`✅ Using alternative filter: found ${onlyApproved.length} members`);
                }
                
                console.log(`✅ Final verified: ${onlyApproved.length} approved members (from ${activeMembers.length})`);
                if (onlyApproved.length === 0 && activeMembers.length > 0) {
                    console.log('📊 DEBUG: All members that could not be filtered:');
                    activeMembers.forEach(m => {
                        console.log(`  - ${m.user_id || m.id}: status="${m.status}"`);
                    });
                }
                
                
                // Update stats card for active members
                const activeMembersCountEl = document.querySelector('.stat-card:nth-child(2) h3');
                if (activeMembersCountEl) {
                    activeMembersCountEl.textContent = onlyApproved.length;
                    console.log('✅ Updated active members stats card to:', onlyApproved.length);
                }
                
                // Populate the active members table (with approved members only)
                populateActiveMembersTable(onlyApproved);
                
            } catch (error) {
                console.error('❌ Error loading active members:', error);
                console.error('Error details:', {
                    message: error.message,
                    stack: error.stack,
                    response: error.response
                });
                populateActiveMembersTable([]);
            }
            
            console.log('=== Load active members complete ===');
        }

        // Populate active members table
        function populateActiveMembersTable(members) {
            const tbody = document.querySelector('#active-members table tbody');
            if (!tbody) {
                console.error('Active members table body not found!');
                return;
            }
            
            tbody.innerHTML = '';
            
            console.log('Populating active members table with', members.length, 'members');
            console.log('Members to display:', members.map(m => ({ id: m.user_id || m.id, status: m.status, name: m.user_first_name || m.first_name || m.name })));
            
            // Members are already filtered for approval status by loadActiveMembers()
            // Just display them directly without re-filtering
            const approvedMembers = members;
            
            console.log(`✅ Will display ${approvedMembers.length} members in table`);
            
            if (approvedMembers.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" style="text-align: center; padding: 40px; color: var(--gray);">
                            <i class="fas fa-users" style="font-size: 48px; display: block; margin-bottom: 15px;"></i>
                            <p style="font-size: 1.1rem; margin-bottom: 5px;">No active members yet</p>
                            <p style="font-size: 0.9rem;">Approve pending requests to add members to your tontine.</p>
                        </td>
                    </tr>
                `;
                return;
            }
            
            approvedMembers.forEach(member => {
                const row = document.createElement('tr');
                // Log the complete member object to see what data we have
                console.log('📋 Complete member object:', member);
                console.log('📋 Available keys:', Object.keys(member));
                
                // Extract user data - check if it's nested in a 'user' object
                const userData = member.user || member;
                console.log('👤 User data object:', userData);
                
                // Handle multiple possible field name variations
                const firstName = userData.first_name || userData.firstName || userData.user_first_name || member.first_name || '';
                const lastName = userData.last_name || userData.lastName || userData.user_last_name || member.last_name || '';
                const memberName = `${firstName} ${lastName}`.trim() || userData.name || userData.username || 'Unknown User';
                const memberEmail = userData.email || userData.user_email || member.email || 'No email provided';
                const memberPhone = userData.phone || userData.phone_number || userData.user_phone || member.phone || 'No phone provided';
                const memberId = member.user_id || userData.id || member.id || 'unknown';
                
                // Handle date formatting
                const dateValue = member.created_at || member.joined_at || member.join_date || userData.created_at;
                const joinDate = dateValue ? new Date(dateValue).toLocaleDateString() : 'N/A';
                
                console.log('✅ Extracted data:', { 
                    firstName, 
                    lastName, 
                    memberName, 
                    memberEmail, 
                    memberPhone, 
                    memberId,
                    joinDate 
                });
                
                row.innerHTML = `
                    <td>${memberName}</td>
                    <td>${memberEmail}</td>
                    <td>${memberPhone}</td>
                    <td>${joinDate}</td>
                    <td><span class="status-badge status-active">Active</span></td>
                    <td>
                        <div class="action-buttons">
                            <button class="action-btn view" onclick="viewMemberDetails('${memberId}')" title="View member details">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="action-btn approve" onclick="sendMessage('${memberId}', '${memberName.replace(/'/g, "\\'")}')}" title="Send message">
                                <i class="fas fa-envelope"></i>
                            </button>
                            <button class="action-btn delete" onclick="removeMember('${memberId}', '${memberName.replace(/'/g, "\\'")}')}" title="Remove member">
                                <i class="fas fa-user-minus"></i>
                            </button>
                        </div>
                    </td>
                `;
                
                tbody.appendChild(row);
            });
        }

        // Send message to member
        function sendMessage(memberId, memberName) {
            const message = prompt(`Send a message to ${memberName}:`);
            if (message && message.trim()) {
                alert(`Message sent to ${memberName}!\n\n(Note: This is a placeholder. Message functionality will be implemented with backend integration.)`);
                console.log('Message to', memberId, ':', message);
            }
        }

        // Remove member from group
        async function removeMember(memberId, memberName) {
            const reason = prompt(`Enter reason for removing ${memberName} from the group:`);
            if (!reason) {
                return;
            }
            
            if (!confirm(`Are you sure you want to remove ${memberName} from the group?\n\nReason: ${reason}`)) {
                return;
            }
            
            try {
                const user = TokenManager.getUser();
                const groupsResponse = await GroupsAPI.getAll();
                const leaderGroups = groupsResponse.groups?.filter(g => g.leader_id === user.id) || [];
                
                if (leaderGroups.length === 0) {
                    alert('No group found where you are the leader');
                    return;
                }
                
                const groupId = leaderGroups[0].id;
                
                console.log('Removing member:', {
                    userId: memberId,
                    userName: memberName,
                    groupId: groupId,
                    reason: reason
                });
                
                // Call API to remove member
                const response = await GroupsAPI.removeMember(groupId, memberId, reason);
                console.log('Remove response:', response);
                
                alert(`${memberName} has been removed from the group.`);
                
                // Reload active members
                await loadActiveMembers();
            } catch (error) {
                console.error('Error removing member:', error);
                alert('Failed to remove member: ' + error.message);
            }
        }

        // Populate pending requests table
        function populatePendingRequestsTable(requests) {
            const tbody = document.querySelector('#pending-requests table tbody');
            if (!tbody) {
                console.error('Pending requests table body not found!');
                return;
            }
            
            tbody.innerHTML = '';
            
            console.log('Populating pending requests table with', requests.length, 'requests');
            
            if (requests.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" style="text-align: center; padding: 40px; color: var(--gray);">
                            <i class="fas fa-inbox" style="font-size: 48px; display: block; margin-bottom: 15px;"></i>
                            <p style="font-size: 1.1rem; margin-bottom: 5px;">No pending requests</p>
                            <p style="font-size: 0.9rem;">New membership requests will appear here for your approval.</p>
                        </td>
                    </tr>
                `;
                return;
            }
            
            requests.forEach(request => {
                const row = document.createElement('tr');
                const requestDate = new Date(request.created_at || request.joined_at || Date.now()).toLocaleDateString();
                
                // Handle both naming conventions from backend
                const firstName = request.first_name || request.user_first_name || '';
                const lastName = request.last_name || request.user_last_name || '';
                const userName = `${firstName} ${lastName}`.trim() || 'Unknown';
                const userEmail = request.email || request.user_email || 'N/A';
                const userPhone = request.phone || request.user_phone || 'No phone';
                const userId = request.user_id || request.id;
                
                console.log('Rendering request:', { firstName, lastName, userName, userEmail, userPhone, userId });
                
                row.innerHTML = `
                    <td>${userName}</td>
                    <td>${requestDate}</td>
                    <td>${userEmail}<br><small>${userPhone}</small></td>
                    <td><span class="status-badge status-pending">Pending</span></td>
                    <td>
                        <div class="action-buttons">
                            <button class="action-btn approve" onclick="approveMemberRequest('${userId}', '${userName.replace(/'/g, "\\'")}')">
                                <i class="fas fa-check"></i> Approve
                            </button>
                            <button class="action-btn reject" onclick="rejectMemberRequest('${userId}', '${userName.replace(/'/g, "\\'")}')">
                                <i class="fas fa-times"></i> Reject
                            </button>
                            <button class="action-btn view" onclick="viewMemberDetails('${userId}')">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                    </td>
                `;
                
                tbody.appendChild(row);
            });
        }

        // Approve member request
        async function approveMemberRequest(userId, userName) {
            if (!confirm(`Approve ${userName}'s membership request?`)) {
                return;
            }
            
            try {
                const user = TokenManager.getUser();
                console.log('Current user:', user);
                
                const groupsResponse = await GroupsAPI.getAll();
                console.log('All groups:', groupsResponse);
                
                const leaderGroups = groupsResponse.groups?.filter(g => 
                    g.leader_id === user.id
                ) || [];
                
                console.log('Leader groups:', leaderGroups);
                
                if (leaderGroups.length === 0) {
                    alert('No group found where you are the leader');
                    return;
                }
                
                const groupId = leaderGroups[0].id;
                
                console.log('Approving member:', {
                    userId: userId,
                    userName: userName,
                    groupId: groupId,
                    groupName: leaderGroups[0].name
                });
                
                // Call API to approve member
                const response = await GroupsAPI.approveMember(groupId, userId);
                console.log('Approve response:', response);
                
                alert(`${userName} has been approved as a member!`);
                
                // Reload both pending requests AND active members
                await loadPendingRequests();
                await loadActiveMembers();
            } catch (error) {
                console.error('Error approving member:', error);
                console.error('Error details:', {
                    message: error.message,
                    response: error.response,
                    stack: error.stack
                });
                alert('Failed to approve member: ' + error.message);
            }
        }

        // Reject member request
        async function rejectMemberRequest(userId, userName) {
            const reason = prompt(`Enter reason for rejecting ${userName}:`);
            if (!reason) {
                return;
            }
            
            try {
                const user = TokenManager.getUser();
                console.log('Current user:', user);
                
                const groupsResponse = await GroupsAPI.getAll();
                console.log('All groups:', groupsResponse);
                
                const leaderGroups = groupsResponse.groups?.filter(g => 
                    g.leader_id === user.id
                ) || [];
                
                console.log('Leader groups:', leaderGroups);
                
                if (leaderGroups.length === 0) {
                    alert('No group found where you are the leader');
                    return;
                }
                
                const groupId = leaderGroups[0].id;
                
                console.log('Rejecting member:', {
                    userId: userId,
                    userName: userName,
                    groupId: groupId,
                    groupName: leaderGroups[0].name,
                    reason: reason
                });
                
                // Call API to reject member
                const response = await GroupsAPI.removeMember(groupId, userId, reason);
                console.log('Reject response:', response);
                
                alert(`${userName}'s request has been rejected.`);
                
                // Reload pending requests
                await loadPendingRequests();
            } catch (error) {
                console.error('Error rejecting member:', error);
                console.error('Error details:', {
                    message: error.message,
                    response: error.response,
                    stack: error.stack
                });
                alert('Failed to reject member: ' + error.message);
            }
        }

        // View member details - Make it globally accessible
        window.viewMemberDetails = function(userId) {
            console.log('🔍 Viewing member details for userId:', userId);
            
            // Use the globally stored group ID
            const groupId = currentGroupId;
            
            if (!groupId) {
                console.error('❌ No group ID available. Please wait for the page to load completely.');
                alert('Error: Group information not loaded yet. Please wait a moment and try again.');
                return;
            }

            // Get member data from the active members we already loaded
            const activeMembersTable = document.querySelector('#active-members table tbody');
            
            if (!activeMembersTable) {
                console.error('❌ Active members table not found in DOM');
                // Fetch from API instead
                fetchMemberDetailsFromAPI(userId, groupId);
                return;
            }
            
            const rows = activeMembersTable.querySelectorAll('tr');
            
            let memberData = null;
            
            // Try to find member from current table data
            rows.forEach(row => {
                const cells = row.querySelectorAll('td');
                if (cells.length >= 4) {
                    const name = cells[0].textContent;
                    const email = cells[1].textContent;
                    const phone = cells[2].textContent;
                    const joinDate = cells[3].textContent;
                    
                    // Create member data object
                    if (!memberData) {
                        memberData = {
                            name: name,
                            email: email,
                            phone: phone,
                            joinDate: joinDate,
                            userId: userId,
                            status: 'Active'
                        };
                    }
                }
            });
            
            // If we couldn't find it in the table, fetch from API
            if (!memberData) {
                // Fetch member details from backend
                fetchMemberDetailsFromAPI(userId, groupId);
                return;
            }
            
            // Populate modal with member data
            populateMemberDetailsModal(memberData);
            
            // Open the modal
            openModal('memberDetailsModal');
        }

        async function fetchMemberDetailsFromAPI(userId, groupId) {
            try {
                console.log('📡 Fetching member details from API...');
                
                // Try to get member details from the group members endpoint
                const response = await GroupsAPI.getMembers(groupId);
                console.log('API Response:', response);
                
                const members = response.members || response || [];
                const member = members.find(m => {
                    const memberId = m.user_id || m.id || (m.user && m.user.id);
                    return memberId === userId;
                });
                
                if (member) {
                    const userData = member.user || member;
                    const memberData = {
                        name: `${userData.first_name || userData.firstName || ''} ${userData.last_name || userData.lastName || ''}`.trim() || userData.name || 'Unknown User',
                        email: userData.email || 'No email provided',
                        phone: userData.phone || userData.phone_number || 'No phone provided',
                        joinDate: member.created_at ? new Date(member.created_at).toLocaleDateString() : 'N/A',
                        userId: userId,
                        status: member.status === 'approved' ? 'Active' : member.status || 'Unknown'
                    };
                    
                    populateMemberDetailsModal(memberData);
                    openModal('memberDetailsModal');
                } else {
                    alert('Member details not found');
                }
            } catch (error) {
                console.error('Error fetching member details:', error);
                alert('Error loading member details: ' + error.message);
            }
        }

        window.populateMemberDetailsModal = function(memberData) {
            // Populate personal information
            document.getElementById('detailName').textContent = memberData.name || 'N/A';
            document.getElementById('detailEmail').textContent = memberData.email || 'N/A';
            document.getElementById('detailPhone').textContent = memberData.phone || 'N/A';
            document.getElementById('detailJoinDate').textContent = memberData.joinDate || 'N/A';
            
            // Populate membership status
            const statusSpan = document.getElementById('detailStatus');
            statusSpan.textContent = memberData.status || 'Unknown';
            statusSpan.className = 'status-badge status-' + (memberData.status === 'Active' ? 'active' : 'pending');
            
            document.getElementById('detailUserId').textContent = memberData.userId || 'N/A';
            
            // Store current member for sending messages
            window.currentViewedMember = memberData;
            
            console.log('✅ Member details populated:', memberData);
        }

        window.sendMessageToMember = function() {
            if (window.currentViewedMember) {
                closeModal('memberDetailsModal');
                sendMessage(window.currentViewedMember.userId, window.currentViewedMember.name);
            }
        }

        // Initialize language on page load
        document.addEventListener('DOMContentLoaded', async function() {
            // Check if user is logged in
            if (!TokenManager.isLoggedIn()) {
                window.location.href = 'login.html';
                return;
            }
            
            // Load user data (includes group approval check)
            await loadUserData();
            
            // Load pending requests and active members
            await loadPendingRequests();
            await loadActiveMembers();
            
            // Give time for userGroup to be set in localStorage, then load tables
            setTimeout(() => {
                loadPaidLoans();
                loadContributionSummary();
            }, 500);
            
            // Load saved language preference
            const savedLang = localStorage.getItem('preferredLanguage') || 'en';
            switchLanguage(savedLang);
            
            // Setup language switcher buttons
            document.querySelectorAll('.language-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    switchLanguage(this.dataset.lang);
                });
            });
            
            // Verify viewMemberDetails function is accessible
            console.log('✅ viewMemberDetails function available:', typeof window.viewMemberDetails === 'function');
            
            // Initialize calendar
            const calendarEl = document.getElementById('calendar');
            const calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                headerToolbar: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'dayGridMonth,timeGridWeek,timeGridDay'
                },
                events: [
                    {
                        title: 'Monthly Meeting',
                        start: '2023-10-15',
                        color: '#3498db'
                    },
                    {
                        title: 'Contribution Deadline',
                        start: '2023-10-20',
                        color: '#e74c3c'
                    },
                    {
                        title: 'Loan Committee',
                        start: '2023-10-25',
                        color: '#27ae60'
                    }
                ]
            });
            calendar.render();
        });
        
        // Tab functionality
        document.querySelectorAll('.tab-btn').forEach(button => {
            button.addEventListener('click', () => {
                const tabId = button.getAttribute('data-tab');
                
                // Remove active class from all tabs and contents
                document.querySelectorAll('.tab-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                document.querySelectorAll('.tab-content').forEach(content => {
                    content.classList.remove('active');
                });
                
                // Add active class to current tab
                button.classList.add('active');
                document.getElementById(tabId).classList.add('active');
            });
        });
        
        // Event delegation for dynamically created action buttons
        document.addEventListener('click', function(e) {
            // Check if clicked element is the view button or its child icon
            const viewBtn = e.target.closest('.action-btn.view');
            if (viewBtn && viewBtn.onclick) {
                // The inline onclick will handle it
                return;
            }
            
            // Backup: If inline onclick doesn't work, extract userId from onclick attribute
            if (viewBtn) {
                const onclickAttr = viewBtn.getAttribute('onclick');
                if (onclickAttr) {
                    const match = onclickAttr.match(/viewMemberDetails\('([^']+)'\)/);
                    if (match && match[1]) {
                        console.log('📌 Event delegation: Calling viewMemberDetails for', match[1]);
                        window.viewMemberDetails(match[1]);
                    }
                }
            }
        });
        
        // Copy link functionality
        document.getElementById('copy-link').addEventListener('click', function() {
            const linkInput = document.querySelector('.link-input');
            linkInput.select();
            document.execCommand('copy');
            
            // Show feedback
            const originalText = this.innerHTML;
            this.innerHTML = '<i class="fas fa-check"></i> Copied!';
            setTimeout(() => {
                this.innerHTML = originalText;
            }, 2000);
        });
        
        // Sample data for loan statistics
        const loanStats = {
            rapidLoans: 2,
            underReview: 3,
            confirmedLoans: 5,
            totalLoanAmount: 2500
        };
        
        // Update stats with dynamic data
        document.querySelectorAll('.loan-stats span').forEach(stat => {
            if (stat.textContent.includes('Active:')) {
                if (stat.closest('.loan-card').querySelector('h4').textContent.includes('Rapid')) {
                    stat.textContent = `Active: ${loanStats.rapidLoans}`;
                } else if (stat.closest('.loan-card').querySelector('h4').textContent.includes('Confirmed')) {
                    stat.textContent = `Active: ${loanStats.confirmedLoans}`;
                }
            } else if (stat.textContent.includes('Applications:')) {
                stat.textContent = `Applications: ${loanStats.underReview}`;
            } else if (stat.textContent.includes('Total:')) {
                stat.textContent = `Total: $${loanStats.totalLoanAmount}`;
            }
        });
        
        // Notification form submission
        document.querySelector('.btn-primary').addEventListener('click', function(e) {
            if (this.textContent.includes('Send to All Members')) {
                const notificationText = document.querySelector('textarea').value;
                if (notificationText.trim()) {
                    alert('Notification sent to all members!');
                    document.querySelector('textarea').value = '';
                } else {
                    alert('Please write a notification before sending.');
                }
            }
        });
        
        // Approve/Reject member functionality
        document.querySelectorAll('.action-btn.approve').forEach(button => {
            button.addEventListener('click', function() {
                const memberName = this.closest('tr').querySelector('td').textContent;
                if (confirm(`Approve ${memberName}'s request to join the tontine?`)) {
                    this.closest('tr').style.opacity = '0.5';
                    setTimeout(() => {
                        this.closest('tr').remove();
                        // Update pending requests count
                        const pendingTab = document.querySelector('[data-tab="pending-requests"]');
                        const currentCount = parseInt(pendingTab.textContent.match(/\d+/)[0]);
                        pendingTab.textContent = pendingTab.textContent.replace(/\d+/, currentCount - 1);
                    }, 500);
                }
            });
        });
        
        // Simple loan approval simulation
        document.querySelectorAll('.action-btn.approve').forEach(button => {
            if (button.textContent.includes('Approve') && !button.textContent.includes('Envelope')) {
                button.addEventListener('click', function() {
                    const row = this.closest('tr');
                    const memberName = row.querySelector('td').textContent;
                    const amount = row.querySelector('td:nth-child(3)').textContent;
                    
                    if (confirm(`Approve ${memberName}'s loan request for ${amount}?`)) {
                        row.querySelector('.status-badge').textContent = 'Confirmed';
                        row.querySelector('.status-badge').className = 'status-badge status-active';
                        row.querySelector('.action-buttons').innerHTML = '<button class="action-btn view">View</button>';
                    }
                });
            }
        });
        
        // Leader Contribution Functions
        document.getElementById('leaderPaymentMethod').addEventListener('change', function() {
            const mobileField = document.getElementById('leaderMobileNumberField');
            const bankField = document.getElementById('leaderBankDetailsField');
            
            if (this.value === 'mobile') {
                mobileField.style.display = 'block';
                bankField.style.display = 'none';
            } else if (this.value === 'bank') {
                mobileField.style.display = 'none';
                bankField.style.display = 'block';
            } else {
                mobileField.style.display = 'none';
                bankField.style.display = 'none';
            }
        });
        
        function processLeaderContribution() {
            const amount = document.getElementById('leaderContributionAmount').value;
            const method = document.getElementById('leaderPaymentMethod').value;
            
            if (!amount) {
                alert('Please enter a contribution amount');
                return;
            }
            
            if (amount < 10000) {
                alert('Minimum contribution is 10,000 RWF');
                return;
            }
            
            let details = '';
            if (method === 'mobile') {
                const mobileNumber = document.getElementById('leaderMobileNumber').value;
                if (!mobileNumber) {
                    alert('Please enter your mobile number');
                    return;
                }
                details = ` via Mobile Money (${mobileNumber})`;
            } else if (method === 'bank') {
                const bankDetails = document.getElementById('leaderBankDetails').value;
                if (!bankDetails.trim()) {
                    alert('Please enter your bank account details');
                    return;
                }
                details = ' via Bank Transfer';
            } else {
                details = ' via Cash';
            }
            
            // Process payment
            alert(`Contribution of ${amount.toLocaleString()} RWF${details} has been recorded successfully!`);
            
            // Reset form
            document.getElementById('leaderContributionAmount').value = '';
            document.getElementById('leaderMobileNumber').value = '';
            document.getElementById('leaderBankDetails').value = '';
        }
    </script>

    <!-- Edit Member Modal -->
    <div id="editMemberModal" class="modal">
        <div class="modal-content modal-content-large">
            <div class="modal-header">
                <h2 id="editMemberTitle">Edit Member Information</h2>
                <button class="modal-close" onclick="closeModal('editMemberModal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="editMemberForm">
                    <div class="form-group">
                        <label for="editMemberName">Full Name</label>
                        <input type="text" id="editMemberName" class="form-input" required>
                    </div>

                    <div class="form-group mt-20">
                        <label for="editMemberEmail">Email Address</label>
                        <input type="email" id="editMemberEmail" class="form-input" required>
                    </div>

                    <div class="form-group mt-20">
                        <label for="editMemberPhone">Phone Number</label>
                        <input type="tel" id="editMemberPhone" class="form-input" required>
                    </div>

                    <div class="form-group mt-20">
                        <label for="editMemberPosition">Position in Group</label>
                        <input type="text" id="editMemberPosition" class="form-input" placeholder="e.g. Member, Treasurer, Secretary">
                    </div>

                    <div class="form-group mt-20">
                        <label for="editMemberAddress">Address</label>
                        <input type="text" id="editMemberAddress" class="form-input">
                    </div>

                    <div class="form-group mt-20">
                        <label for="editMemberCity">City/District</label>
                        <input type="text" id="editMemberCity" class="form-input">
                    </div>

                    <div class="form-group mt-20">
                        <label for="editMemberStatus">Member Status</label>
                        <select id="editMemberStatus" class="form-input" title="Select member status">
                            <option value="active">Active</option>
                            <option value="inactive">Inactive</option>
                            <option value="suspended">Suspended</option>
                        </select>
                    </div>

                    <div class="form-group mt-20">
                        <label for="editMemberNotes">Notes</label>
                        <textarea id="editMemberNotes" class="form-input textarea-tall"></textarea>
                    </div>

                    <div class="modal-actions mt-25">
                        <button type="button" class="btn btn-secondary" onclick="closeModal('editMemberModal')">Cancel</button>
                        <button type="submit" class="btn btn-primary">Save Changes</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Delete Member Confirmation Modal -->
    <div id="deleteMemberModal" class="modal">
        <div class="modal-content modal-content-medium">
            <div class="modal-header">
                <h2>Confirm Delete Member</h2>
                <button class="modal-close" onclick="closeModal('deleteMemberModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="info-box info-box-danger">
                    <p><strong>Warning!</strong> This action cannot be undone.</p>
                    <p>Are you sure you want to delete <strong id="deleteMemberName">this member</strong> from the group?</p>
                </div>
                <p class="warning-text">All their contribution history and related data will be permanently removed.</p>

                <div class="modal-actions mt-25">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('deleteMemberModal')">Cancel</button>
                    <button type="button" class="btn btn-danger" onclick="confirmDeleteMember()">Delete Member</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Member Details Modal -->
    <div id="memberDetailsModal" class="modal">
        <div class="modal-content modal-content-large">
            <div class="modal-header">
                <h2>Member Details</h2>
                <button class="modal-close" onclick="closeModal('memberDetailsModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div id="memberDetailsContent">
                    <div class="member-details-section">
                        <h3><i class="fas fa-user"></i> Personal Information</h3>
                        <div class="details-grid">
                            <div class="detail-item">
                                <label>Full Name:</label>
                                <span id="detailName">-</span>
                            </div>
                            <div class="detail-item">
                                <label>Email:</label>
                                <span id="detailEmail">-</span>
                            </div>
                            <div class="detail-item">
                                <label>Phone:</label>
                                <span id="detailPhone">-</span>
                            </div>
                            <div class="detail-item">
                                <label>Member Since:</label>
                                <span id="detailJoinDate">-</span>
                            </div>
                        </div>
                    </div>

                    <div class="member-details-section mt-20">
                        <h3><i class="fas fa-chart-line"></i> Membership Status</h3>
                        <div class="details-grid">
                            <div class="detail-item">
                                <label>Status:</label>
                                <span id="detailStatus">-</span>
                            </div>
                            <div class="detail-item">
                                <label>User ID:</label>
                                <span id="detailUserId">-</span>
                            </div>
                        </div>
                    </div>

                    <div class="member-details-section mt-20">
                        <h3><i class="fas fa-wallet"></i> Contribution Summary</h3>
                        <div class="details-grid">
                            <div class="detail-item">
                                <label>Total Contributions:</label>
                                <span id="detailTotalContributions">RWF 0</span>
                            </div>
                            <div class="detail-item">
                                <label>Last Contribution:</label>
                                <span id="detailLastContribution">Never</span>
                            </div>
                            <div class="detail-item">
                                <label>Payment Status:</label>
                                <span id="detailPaymentStatus">Up to date</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="modal-actions mt-25">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('memberDetailsModal')">Close</button>
                    <button type="button" class="btn btn-primary" onclick="sendMessageToMember()">
                        <i class="fas fa-envelope"></i> Send Message
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Payment Approval Modal -->
    <div id="paymentApprovalModal" class="modal">
        <div class="modal-content modal-content-medium">
            <div class="modal-header">
                <h2><i class="fas fa-credit-card"></i> Payment Request Approval</h2>
                <button class="modal-close" onclick="closeModal('paymentApprovalModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="detail-item" style="margin-bottom: 15px;">
                    <label>Member Name:</label>
                    <span id="paymentMemberName" style="font-weight: 600; color: var(--primary);">-</span>
                </div>
                
                <div class="detail-item" style="margin-bottom: 15px;">
                    <label>Payment Amount:</label>
                    <span id="paymentAmount" style="font-size: 1.3rem; font-weight: 600; color: var(--success);">-</span>
                </div>
                
                <div class="detail-item" style="margin-bottom: 15px;">
                    <label>Payment Method:</label>
                    <span id="paymentMethod" style="font-weight: 600;">-</span>
                </div>
                
                <div class="detail-item" style="margin-bottom: 20px;">
                    <label>Receipt:</label>
                    <a href="#" id="paymentReceiptLink" style="color: var(--primary); text-decoration: underline;">View Receipt</a>
                </div>
                
                <div style="background: var(--gray-light); padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                    <p style="margin: 0; font-size: 0.9rem; color: #666;">
                        <i class="fas fa-info-circle"></i>
                        Once approved, this payment will be recorded as a contribution for the member.
                    </p>
                </div>

                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('paymentApprovalModal')" style="flex: 1;">Cancel</button>
                    <button type="button" class="btn btn-danger" onclick="rejectPayment()" style="flex: 1;">
                        <i class="fas fa-times"></i> Reject
                    </button>
                    <button type="button" class="btn btn-success" onclick="approvePayment()" style="flex: 1;">
                        <i class="fas fa-check"></i> Approve
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Loan Settings Modal -->
    <div id="loanSettingsModal" class="modal">
        <div class="modal-content" style="width: 90%; max-width: 500px;">
            <div class="modal-header">
                <h2>Loan Settings</h2>
                <span class="close-btn" onclick="closeModal('loanSettingsModal')">&times;</span>
            </div>
            <div class="modal-body" style="padding: 20px;">
                <form id="loanSettingsForm">
                    <div class="form-group" style="margin-bottom: 20px;">
                        <label for="maxRapidLoan" style="display: block; margin-bottom: 8px; font-weight: 600;">
                            <i class="fas fa-bolt"></i> Maximum Rapid Loan Amount (RWF)
                        </label>
                        <p style="font-size: 0.85rem; color: #666; margin-bottom: 10px;">
                            Set the maximum amount members can borrow as rapid loans (repayable within 30 days)
                        </p>
                        <input type="number" id="maxRapidLoan" name="maxRapidLoan" placeholder="e.g., 50000" min="0" style="width: 100%; padding: 10px; border: 1px solid var(--gray-light); border-radius: 6px;">
                    </div>
                    
                    <div class="form-group" style="margin-bottom: 20px;">
                        <label for="maxLongLoan" style="display: block; margin-bottom: 8px; font-weight: 600;">
                            <i class="fas fa-hourglass"></i> Maximum Long Loan Amount (RWF)
                        </label>
                        <p style="font-size: 0.85rem; color: #666; margin-bottom: 10px;">
                            Set the maximum amount for long-term loans (repayable within tontine cycle)
                        </p>
                        <input type="number" id="maxLongLoan" name="maxLongLoan" placeholder="e.g., 150000" min="0" style="width: 100%; padding: 10px; border: 1px solid var(--gray-light); border-radius: 6px;">
                    </div>
                    
                    <div class="form-group" style="margin-bottom: 20px;">
                        <label for="loanInterestRate" style="display: block; margin-bottom: 8px; font-weight: 600;">
                            <i class="fas fa-percent"></i> Loan Interest Rate (%)
                        </label>
                        <p style="font-size: 0.85rem; color: #666; margin-bottom: 10px;">
                            Set the monthly interest rate on all loans
                        </p>
                        <input type="number" id="loanInterestRate" name="loanInterestRate" placeholder="e.g., 2.5" min="0" step="0.1" style="width: 100%; padding: 10px; border: 1px solid var(--gray-light); border-radius: 6px;">
                    </div>
                    
                    <div style="background: var(--gray-light); padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                        <h4 style="margin-top: 0; color: var(--dark);">Loan Types Info:</h4>
                        <ul style="margin: 10px 0; font-size: 0.9rem; color: #666;">
                            <li><strong>Rapid Loans:</strong> Short-term, must be repaid within 30 days of approval</li>
                            <li><strong>Long Loans:</strong> Extended term, must be repaid within the current tontine cycle</li>
                        </ul>
                    </div>
                </form>
                
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('loanSettingsModal')" style="flex: 1;">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveLoanSettings()" style="flex: 1;">
                        <i class="fas fa-save"></i> Save Settings
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Loan Approval Receipt Modal -->
    <div id="loanApprovalReceiptModal" class="modal">
        <div class="modal-content" style="width: 95%; max-width: 600px;">
            <div class="modal-header">
                <h2><i class="fas fa-receipt"></i> Upload Approval Receipt</h2>
                <span class="close-btn" onclick="closeLoanApprovalReceiptModal()">&times;</span>
            </div>
            <div class="modal-body" style="padding: 20px;">
                <p style="color: var(--gray); margin-bottom: 20px;">
                    <i class="fas fa-info-circle" style="margin-right: 8px;"></i>
                    Please upload a receipt showing the payment/transfer was sent to the member before approving the loan request.
                </p>
                
                <form id="loanApprovalReceiptForm">
                    <input type="hidden" id="loanApprovalLoanId">
                    <input type="hidden" id="loanApprovalLoanType">
                    
                    <div class="form-group" style="margin-bottom: 15px;">
                        <label style="font-weight: 600; margin-bottom: 8px; display: block;">Loan Amount</label>
                        <input type="number" id="loanApprovalAmount" disabled style="width: 100%; padding: 10px; border: 1px solid var(--gray-light); border-radius: 6px; background-color: var(--gray-light); cursor: not-allowed;">
                    </div>
                    
                    <div class="form-group" style="margin-bottom: 15px;">
                        <label style="font-weight: 600; margin-bottom: 8px; display: block;">Transaction Date</label>
                        <input type="date" id="loanApprovalTransactionDate" required style="width: 100%; padding: 10px; border: 1px solid var(--gray-light); border-radius: 6px;">
                    </div>
                    
                    <div class="form-group" style="border: 2px dashed var(--primary); border-radius: 8px; padding: 20px; background: var(--gray-light); margin-bottom: 15px;">
                        <label style="font-weight: 600; margin-bottom: 10px; display: block;">
                            <i class="fas fa-upload" style="margin-right: 8px;"></i>
                            Upload Receipt (Screenshot/PDF)
                        </label>
                        <input type="file" id="loanApprovalReceiptFile" accept=".jpg,.jpeg,.png,.pdf" required style="display: block; width: 100%; margin-top: 10px;">
                        <small style="color: var(--gray); font-size: 0.85rem; margin-top: 8px; display: block;">
                            <i class="fas fa-check-circle" style="color: var(--success); margin-right: 5px;"></i>
                            Accepted: JPG, PNG, PDF (Max 5MB)
                        </small>
                    </div>
                </form>
            </div>
            <div class="modal-actions">
                <button type="button" class="btn btn-secondary" onclick="closeLoanApprovalReceiptModal()">
                    <i class="fas fa-times"></i> Cancel
                </button>
                <button type="button" class="btn btn-primary" onclick="submitLoanApprovalReceipt()">
                    <i class="fas fa-check"></i> Approve with Receipt
                </button>
            </div>
        </div>
    </div>

    <!-- Loans List Modal -->
    <div id="loansListModal" class="modal">
        <div class="modal-content" style="width: 95%; max-width: 900px; max-height: 80vh; overflow-y: auto;">
            <div class="modal-header">
                <h2><i class="fas fa-credit-card"></i> <span id="loansListTitle">Loans List</span></h2>
                <span class="close-btn" onclick="closeModal('loansListModal')">&times;</span>
            </div>
            <div class="modal-body" style="padding: 20px;">
                <div id="loansListContent">
                    <p style="text-align: center; color: #666;">Loading loans...</p>
                </div>
            </div>
            <div class="modal-actions">
                <button type="button" class="btn btn-secondary" onclick="closeModal('loansListModal')" style="flex: 1;">Close</button>
            </div>
        </div>
    </div>

    <!-- Modal Styles -->
    <style>
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            animation: fadeIn 0.3s ease-in;
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            animation: slideUp 0.3s ease-out;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            border-bottom: 1px solid var(--gray-light);
        }

        .modal-header h2 {
            margin: 0;
            font-size: 1.3rem;
            color: var(--dark);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 28px;
            cursor: pointer;
            color: var(--gray);
            padding: 5px 10px;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            transition: all 0.3s ease;
            font-weight: 300;
            line-height: 1;
        }

        .close-btn:hover {
            background-color: var(--gray-light);
            color: var(--danger);
            transform: rotate(90deg);
        }

        .close-btn:active {
            background-color: #e8eef7;
            transform: rotate(90deg) scale(0.95);
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 2rem;
            cursor: pointer;
            color: var(--gray);
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-close:hover {
            color: var(--dark);
        }

        .modal-body {
            padding: 20px;
        }

        .modal-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            padding: 20px;
            background-color: var(--gray-light);
            border-top: 1px solid #e0e0e0;
        }

        .modal-actions .btn {
            padding: 12px 24px;
            font-weight: 600;
            border-radius: 8px;
            transition: all 0.3s ease;
            border: 2px solid transparent;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .modal-actions .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.12);
        }

        .modal-actions .btn:active {
            transform: translateY(0);
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
        }

        .modal-actions .btn-secondary {
            background-color: white;
            color: var(--primary);
            border: 2px solid var(--primary);
        }

        .modal-actions .btn-secondary:hover {
            background-color: var(--primary);
            color: white;
        }

        .modal-actions .btn-primary {
            background: var(--gradient);
            color: white;
            border: 2px solid transparent;
        }

        .modal-actions .btn-primary:hover {
            box-shadow: 0 6px 20px rgba(46, 91, 255, 0.3);
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-danger:hover {
            background: #e63946;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }

        @keyframes slideUp {
            from {
                transform: translateY(50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        @media (max-width: 768px) {
            .modal-content {
                margin: 20px;
                max-width: calc(100% - 40px);
            }
        }

        /* Modal Content Sizes */
        .modal-content-large {
            max-width: 600px;
        }

        .modal-content-medium {
            max-width: 400px;
        }

        /* Textarea Styles */
        .textarea-tall {
            height: 80px;
        }

        /* Warning Box Styles */
        .info-box-danger {
            background: #ffe0e0;
            border-left: 4px solid var(--danger);
        }

        /* Warning Text */
        .warning-text {
            margin-top: 15px;
            color: #666;
            font-size: 0.9rem;
        }

        /* Member Details Modal Styles */
        .member-details-section {
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .member-details-section h3 {
            margin: 0 0 15px 0;
            font-size: 1.1rem;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .member-details-section h3 i {
            font-size: 1rem;
        }

        .details-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .detail-item {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .detail-item label {
            font-size: 0.85rem;
            color: #666;
            font-weight: 600;
        }

        .detail-item span {
            font-size: 1rem;
            color: var(--dark);
            font-weight: 500;
        }

        @media (max-width: 600px) {
            .details-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>

    <!-- Edit and Delete Member Scripts -->
    <script>
        let currentMemberId = null;
        let currentMemberName = null;

        // Open Edit Member Modal
        function openEditMemberModal(memberName, memberEmail, memberPhone, position = '', address = '', city = '', status = 'active', notes = '') {
            currentMemberId = memberName; // Using name as ID for demo
            currentMemberName = memberName;
            document.getElementById('editMemberName').value = memberName;
            document.getElementById('editMemberEmail').value = memberEmail;
            document.getElementById('editMemberPhone').value = memberPhone;
            document.getElementById('editMemberPosition').value = position;
            document.getElementById('editMemberAddress').value = address;
            document.getElementById('editMemberCity').value = city;
            document.getElementById('editMemberStatus').value = status;
            document.getElementById('editMemberNotes').value = notes;
            openModal('editMemberModal');
        }

        // Open Delete Confirmation Modal
        function openDeleteMemberModal(memberName) {
            currentMemberId = memberName;
            currentMemberName = memberName;
            document.getElementById('deleteMemberName').textContent = memberName;
            openModal('deleteMemberModal');
        }

        // Open Modal
        function openModal(modalId) {
            const modal = document.getElementById(modalId);
            modal.classList.add('active');
        }

        // Close Modal
        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            modal.classList.remove('active');
        }

        // Handle Edit Member Form Submit
        document.getElementById('editMemberForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const name = document.getElementById('editMemberName').value;
            const email = document.getElementById('editMemberEmail').value;
            const phone = document.getElementById('editMemberPhone').value;
            const position = document.getElementById('editMemberPosition').value;
            const address = document.getElementById('editMemberAddress').value;
            const city = document.getElementById('editMemberCity').value;
            const status = document.getElementById('editMemberStatus').value;
            const notes = document.getElementById('editMemberNotes').value;

            // Save changes (in real app, send to server)
            alert(`Member "${name}" information has been updated successfully!\n\nEmail: ${email}\nPhone: ${phone}\nPosition: ${position}\nStatus: ${status}`);
            
            // Update table row in UI
            const rows = document.querySelectorAll('#active-members table tbody tr');
            rows.forEach(row => {
                if (row.cells[0].textContent === currentMemberName) {
                    row.cells[0].textContent = name;
                }
            });

            closeModal('editMemberModal');
        });

        // Confirm Delete Member
        function confirmDeleteMember() {
            alert(`Member "${currentMemberName}" has been deleted from the group.\n\nAll associated data has been removed.`);
            
            // Remove row from table
            const rows = document.querySelectorAll('#active-members table tbody tr');
            rows.forEach(row => {
                if (row.cells[0].textContent === currentMemberName) {
                    row.remove();
                }
            });

            closeModal('deleteMemberModal');
        }

        // Loan Settings Functions
        function openLoanSettingsModal() {
            const user = TokenManager.getUser();
            let groupId = window.currentGroupId || currentGroupId;
            
            if (!groupId) {
                alert('Please load a group first');
                return;
            }
            
            // Load existing settings if any
            const settings = JSON.parse(localStorage.getItem('loanSettings_' + groupId) || '{}');
            document.getElementById('maxRapidLoan').value = settings.maxRapidLoan || '';
            document.getElementById('maxLongLoan').value = settings.maxLongLoan || '';
            document.getElementById('loanInterestRate').value = settings.loanInterestRate || '';
            
            openModal('loanSettingsModal');
        }

        function saveLoanSettings() {
            const user = TokenManager.getUser();
            let groupId = window.currentGroupId || currentGroupId;
            
            if (!groupId) {
                alert('Please load a group first');
                return;
            }
            
            const settings = {
                maxRapidLoan: parseFloat(document.getElementById('maxRapidLoan').value) || 0,
                maxLongLoan: parseFloat(document.getElementById('maxLongLoan').value) || 0,
                loanInterestRate: parseFloat(document.getElementById('loanInterestRate').value) || 0,
                groupId: groupId,
                updatedBy: user.id,
                updatedAt: new Date().toISOString()
            };
            
            // Save to localStorage for now (in production, send to backend)
            localStorage.setItem('loanSettings_' + groupId, JSON.stringify(settings));
            
            console.log('Loan settings saved:', settings);
            alert('Loan settings saved successfully!');
            closeModal('loanSettingsModal');
        }

        // Loan Loading Functions
        function loadRapidLoans() {
            const groupId = window.currentGroupId || currentGroupId;
            if (!groupId) {
                alert('Please load a group first');
                return;
            }
            
            const authToken = localStorage.getItem('authToken');
            if (!authToken) {
                alert('Session expired. Please login again.');
                return;
            }

            document.getElementById('loansListTitle').innerHTML = '<i class="fas fa-bolt"></i> Rapid Loans';
            document.getElementById('loansListContent').innerHTML = '<p style="text-align: center; color: #666;">Loading rapid loans...</p>';
            openModal('loansListModal');

            console.log('Loading Rapid Loans for groupId:', groupId);
            fetch(`${API_CONFIG.BASE_URL}/loans/group/${groupId}`, {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${authToken}`,
                    'Content-Type': 'application/json'
                }
            })
            .then(response => {
                console.log('Rapid Loans Response status:', response.status);
                if (!response.ok) throw new Error('Failed to load rapid loans');
                return response.json();
            })
            .then(data => {
                console.log('Rapid Loans - Raw Data:', data);
                const allLoans = Array.isArray(data) ? data : (data.data || []);
                console.log('Rapid Loans - All Loans:', allLoans);
                // Filter for rapid loans - database returns loan_type (snake_case)
                const loans = allLoans.filter(l => {
                    const type = (l.loan_type || '').toLowerCase();
                    console.log('Rapid: Checking loan type field:', l.loan_type, 'Filtered:', type);
                    return type === 'rapid';
                });
                console.log('Rapid Loans - Filtered to:', loans.length, 'loans');
                const activeLoan = loans.filter(l => l.status === 'approved').length;
                const pendingLoans = loans.filter(l => l.status === 'pending').length;
                const totalActive = loans.filter(l => l.status === 'approved').reduce((sum, l) => sum + (l.amount || 0), 0);
                
                // Update stats
                document.getElementById('rapidLoansActive').textContent = `Active: ${activeLoan}`;
                document.getElementById('rapidLoansPending').textContent = `Pending: ${pendingLoans}`;
                
                // Display table
                let html = `
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="background: var(--gray-light);">
                                <th style="padding: 12px; text-align: left; border-bottom: 2px solid #ddd;">Member</th>
                                <th style="padding: 12px; text-align: left; border-bottom: 2px solid #ddd;">Amount (RWF)</th>
                                <th style="padding: 12px; text-align: left; border-bottom: 2px solid #ddd;">Status</th>
                                <th style="padding: 12px; text-align: left; border-bottom: 2px solid #ddd;">Requested Date</th>
                                <th style="padding: 12px; text-align: left; border-bottom: 2px solid #ddd;">Due Date</th>
                                <th style="padding: 12px; text-align: left; border-bottom: 2px solid #ddd;">Actions</th>
                            </tr>
                        </thead>
                        <tbody>`;
                
                if (loans.length === 0) {
                    html += `<tr><td colspan="6" style="padding: 20px; text-align: center; color: #999;">No rapid loans found</td></tr>`;
                } else {
                    loans.forEach(loan => {
                        const memberName = loan.first_name && loan.last_name ? `${loan.first_name} ${loan.last_name}` : 'Unknown';
                        const statusBadge = `<span style="padding: 4px 12px; border-radius: 20px; font-size: 0.85rem; font-weight: 600; background: ${loan.status === 'approved' ? '#d4edda' : '#fff3cd'}; color: ${loan.status === 'approved' ? '#155724' : '#856404'};"><i class="fas fa-circle" style="font-size: 0.6rem; margin-right: 4px;"></i>${loan.status.charAt(0).toUpperCase() + loan.status.slice(1)}</span>`;
                        const requestedDate = new Date(loan.requested_date).toLocaleDateString();
                        const dueDate = new Date(loan.due_date).toLocaleDateString();
                        
                        html += `
                            <tr style="border-bottom: 1px solid #eee;">
                                <td style="padding: 12px;">${memberName}</td>
                                <td style="padding: 12px; font-weight: 600;">${(loan.amount || 0).toLocaleString('en-RW')}</td>
                                <td style="padding: 12px;">${statusBadge}</td>
                                <td style="padding: 12px;">${requestedDate}</td>
                                <td style="padding: 12px;">${dueDate}</td>
                                <td style="padding: 12px;">
                                    ${loan.status === 'pending' ? `<button class="action-btn approve" onclick="openLoanApprovalReceiptModal('${loan.id}', 'rapid', ${loan.amount}); return false;"><i class="fas fa-check"></i> Approve</button>` : '<span style="color: #999;">Approved</span>'}
                                </td>
                            </tr>`;
                    });
                }
                
                html += `</tbody></table>`;
                document.getElementById('loansListContent').innerHTML = html;
            })
            .catch(error => {
                console.error('Error loading rapid loans:', error);
                document.getElementById('loansListContent').innerHTML = `<p style="text-align: center; color: var(--danger);"><i class="fas fa-exclamation-circle"></i> Error loading rapid loans: ${error.message}</p>`;
            });
        }

        function loadLongLoans() {
            const groupId = window.currentGroupId || currentGroupId;
            if (!groupId) {
                alert('Please load a group first');
                return;
            }
            
            const authToken = localStorage.getItem('authToken');
            if (!authToken) {
                alert('Session expired. Please login again.');
                return;
            }

            document.getElementById('loansListTitle').innerHTML = '<i class="fas fa-hourglass"></i> Long Loans';
            document.getElementById('loansListContent').innerHTML = '<p style="text-align: center; color: #666;">Loading long loans...</p>';
            openModal('loansListModal');

            console.log('Loading Long Loans for groupId:', groupId);
            fetch(`${API_CONFIG.BASE_URL}/loans/group/${groupId}`, {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${authToken}`,
                    'Content-Type': 'application/json'
                }
            })
            .then(response => {
                console.log('Long Loans Response status:', response.status);
                if (!response.ok) throw new Error('Failed to load long loans');
                return response.json();
            })
            .then(data => {
                console.log('Long Loans - Raw Data:', data);
                const allLoans = Array.isArray(data) ? data : (data.data || []);
                console.log('Long Loans - All Loans:', allLoans);
                // Filter for long loans - database returns loan_type (snake_case)
                const loans = allLoans.filter(l => {
                    const type = (l.loan_type || '').toLowerCase();
                    return type === 'long';
                });
                console.log('Long Loans - Filtered to:', loans.length, 'loans');
                const activeLoan = loans.filter(l => l.status === 'approved').length;
                const totalAmount = loans.filter(l => l.status === 'approved').reduce((sum, l) => sum + (l.amount || 0), 0);
                
                // Update stats
                document.getElementById('longLoansActive').textContent = `Active: ${activeLoan}`;
                document.getElementById('longLoansTotal').textContent = `Total: ${totalAmount.toLocaleString('en-RW')} RWF`;
                
                // Display table
                let html = `
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="background: var(--gray-light);">
                                <th style="padding: 12px; text-align: left; border-bottom: 2px solid #ddd;">Member</th>
                                <th style="padding: 12px; text-align: left; border-bottom: 2px solid #ddd;">Amount (RWF)</th>
                                <th style="padding: 12px; text-align: left; border-bottom: 2px solid #ddd;">Status</th>
                                <th style="padding: 12px; text-align: left; border-bottom: 2px solid #ddd;">Requested Date</th>
                                <th style="padding: 12px; text-align: left; border-bottom: 2px solid #ddd;">Due Date</th>
                                <th style="padding: 12px; text-align: left; border-bottom: 2px solid #ddd;">Actions</th>
                            </tr>
                        </thead>
                        <tbody>`;
                
                if (loans.length === 0) {
                    html += `<tr><td colspan="6" style="padding: 20px; text-align: center; color: #999;">No long loans found</td></tr>`;
                } else {
                    loans.forEach(loan => {
                        const memberName = loan.first_name && loan.last_name ? `${loan.first_name} ${loan.last_name}` : 'Unknown';
                        const statusBadge = `<span style="padding: 4px 12px; border-radius: 20px; font-size: 0.85rem; font-weight: 600; background: ${loan.status === 'approved' ? '#d4edda' : '#fff3cd'}; color: ${loan.status === 'approved' ? '#155724' : '#856404'};"><i class="fas fa-circle" style="font-size: 0.6rem; margin-right: 4px;"></i>${loan.status.charAt(0).toUpperCase() + loan.status.slice(1)}</span>`;
                        const requestedDate = new Date(loan.requested_date).toLocaleDateString();
                        const dueDate = new Date(loan.due_date).toLocaleDateString();
                        
                        html += `
                            <tr style="border-bottom: 1px solid #eee;">
                                <td style="padding: 12px;">${memberName}</td>
                                <td style="padding: 12px; font-weight: 600;">${(loan.amount || 0).toLocaleString('en-RW')}</td>
                                <td style="padding: 12px;">${statusBadge}</td>
                                <td style="padding: 12px;">${requestedDate}</td>
                                <td style="padding: 12px;">${dueDate}</td>
                                <td style="padding: 12px;">
                                    ${loan.status === 'pending' ? `<button class="action-btn approve" onclick="openLoanApprovalReceiptModal('${loan.id}', 'long', ${loan.amount}); return false;"><i class="fas fa-check"></i> Approve</button>` : '<span style="color: #999;">Approved</span>'}
                                </td>
                            </tr>`;
                    });
                }
                
                html += `</tbody></table>`;
                document.getElementById('loansListContent').innerHTML = html;
            })
            .catch(error => {
                console.error('Error loading long loans:', error);
                document.getElementById('loansListContent').innerHTML = `<p style="text-align: center; color: var(--danger);"><i class="fas fa-exclamation-circle"></i> Error loading long loans: ${error.message}</p>`;
            });
        }

        function loadConfirmedLoans() {
            const groupId = window.currentGroupId || currentGroupId;
            if (!groupId) {
                alert('Please load a group first');
                return;
            }
            
            const authToken = localStorage.getItem('authToken');
            if (!authToken) {
                alert('Session expired. Please login again.');
                return;
            }

            document.getElementById('loansListTitle').innerHTML = '<i class="fas fa-check-circle"></i> Confirmed Loans';
            document.getElementById('loansListContent').innerHTML = '<p style="text-align: center; color: #666;">Loading confirmed loans...</p>';
            openModal('loansListModal');

            fetch(`${API_CONFIG.BASE_URL}/loans/group/${groupId}`, {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${authToken}`,
                    'Content-Type': 'application/json'
                }
            })
            .then(response => {
                if (!response.ok) throw new Error('Failed to load confirmed loans');
                return response.json();
            })
            .then(data => {
                const allLoans = Array.isArray(data) ? data : (data.data || []);
                // Filter for approved loans only
                const loans = allLoans.filter(l => l.status === 'approved');
                const totalAmount = loans.reduce((sum, l) => sum + (l.amount || 0), 0);
                
                // Update stats
                document.getElementById('confirmedLoansCount').textContent = `Active: ${loans.length}`;
                document.getElementById('confirmedLoansTotal').textContent = `Total: ${totalAmount.toLocaleString('en-RW')} RWF`;
                
                // Display table
                let html = `
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="background: var(--gray-light);">
                                <th style="padding: 12px; text-align: left; border-bottom: 2px solid #ddd;">Member</th>
                                <th style="padding: 12px; text-align: left; border-bottom: 2px solid #ddd;">Type</th>
                                <th style="padding: 12px; text-align: left; border-bottom: 2px solid #ddd;">Amount (RWF)</th>
                                <th style="padding: 12px; text-align: left; border-bottom: 2px solid #ddd;">Due Date</th>
                                <th style="padding: 12px; text-align: left; border-bottom: 2px solid #ddd;">Status</th>
                                <th style="padding: 12px; text-align: left; border-bottom: 2px solid #ddd;">Actions</th>
                            </tr>
                        </thead>
                        <tbody>`;
                
                if (loans.length === 0) {
                    html += `<tr><td colspan="6" style="padding: 20px; text-align: center; color: #999;">No confirmed loans found</td></tr>`;
                } else {
                    loans.forEach(loan => {
                        const memberName = loan.first_name && loan.last_name ? `${loan.first_name} ${loan.last_name}` : 'Unknown';
                        const loanType = (loan.loan_type || '').toUpperCase();
                        const dueDate = new Date(loan.due_date).toLocaleDateString();
                        const isRepaid = loan.is_repaid || loan.repaid_date;
                        const repaidStatus = isRepaid ? '<span style="color: #27ae60; font-weight: 600;"><i class="fas fa-check"></i> Repaid</span>' : '<span style="color: #e74c3c; font-weight: 600;"><i class="fas fa-clock"></i> Active</span>';
                        
                        html += `
                            <tr style="border-bottom: 1px solid #eee;">
                                <td style="padding: 12px;">${memberName}</td>
                                <td style="padding: 12px;"><span style="background: #e3f2fd; color: #1976d2; padding: 3px 8px; border-radius: 4px; font-size: 0.85rem; font-weight: 600;">${loanType}</span></td>
                                <td style="padding: 12px; font-weight: 600;">${(loan.amount || 0).toLocaleString('en-RW')}</td>
                                <td style="padding: 12px;">${dueDate}</td>
                                <td style="padding: 12px;">${repaidStatus}</td>
                                <td style="padding: 12px;">
                                    ${!isRepaid ? `<button class="action-btn approve" onclick="markLoanAsRepaid('${loan.id}'); return false;"><i class="fas fa-check"></i> Mark Repaid</button>` : '<span style="color: #999;">Completed</span>'}
                                </td>
                            </tr>`;
                    });
                }
                
                html += `</tbody></table>`;
                document.getElementById('loansListContent').innerHTML = html;
            })
            .catch(error => {
                console.error('Error loading confirmed loans:', error);
                document.getElementById('loansListContent').innerHTML = `<p style="text-align: center; color: var(--danger);"><i class="fas fa-exclamation-circle"></i> Error loading confirmed loans: ${error.message}</p>`;
            });
        }

        function loadUnderReviewLoans() {
            const groupId = window.currentGroupId || currentGroupId;
            if (!groupId) {
                alert('Please load a group first');
                return;
            }
            
            const authToken = localStorage.getItem('authToken');
            if (!authToken) {
                alert('Session expired. Please login again.');
                return;
            }

            document.getElementById('loansListTitle').innerHTML = '<i class="fas fa-hourglass-half"></i> Loans Under Review';
            document.getElementById('loansListContent').innerHTML = '<p style="text-align: center; color: #666;">Loading loans under review...</p>';
            openModal('loansListModal');

            console.log('Loading loans for groupId:', groupId);
            console.log('API URL:', `${API_CONFIG.BASE_URL}/loans/group/${groupId}`);

            fetch(`${API_CONFIG.BASE_URL}/loans/group/${groupId}`, {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${authToken}`,
                    'Content-Type': 'application/json'
                }
            })
            .then(response => {
                console.log('Response status:', response.status);
                if (!response.ok) throw new Error('Failed to load loans under review');
                return response.json();
            })
            .then(data => {
                console.log('Under Review - Raw Data:', data);
                const allLoans = Array.isArray(data) ? data : (data.data || []);
                console.log('Under Review - All Loans:', allLoans);
                if (allLoans.length > 0) {
                    console.log('Under Review - First loan fields:', Object.keys(allLoans[0]));
                }
                // Filter for pending loans only
                const loans = allLoans.filter(l => l.status === 'pending');
                console.log('Under Review - Filtered Pending Loans:', loans);
                const avgAmount = loans.length > 0 ? loans.reduce((sum, l) => sum + (l.amount || 0), 0) / loans.length : 0;
                
                // Update stats
                document.getElementById('reviewLoansCount').textContent = `Applications: ${loans.length}`;
                document.getElementById('reviewLoansAvg').textContent = `Avg. Amount: ${avgAmount.toLocaleString('en-RW', { maximumFractionDigits: 0 })} RWF`;
                
                // Display table
                let html = `
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="background: var(--gray-light);">
                                <th style="padding: 12px; text-align: left; border-bottom: 2px solid #ddd;">Member</th>
                                <th style="padding: 12px; text-align: left; border-bottom: 2px solid #ddd;">Loan Type</th>
                                <th style="padding: 12px; text-align: left; border-bottom: 2px solid #ddd;">Amount (RWF)</th>
                                <th style="padding: 12px; text-align: left; border-bottom: 2px solid #ddd;">Duration</th>
                                <th style="padding: 12px; text-align: left; border-bottom: 2px solid #ddd;">Requested Date</th>
                                <th style="padding: 12px; text-align: left; border-bottom: 2px solid #ddd;">Actions</th>
                            </tr>
                        </thead>
                        <tbody>`;
                
                if (loans.length === 0) {
                    html += `<tr><td colspan="6" style="padding: 20px; text-align: center; color: #999;">No loans under review</td></tr>`;
                } else {
                    loans.forEach(loan => {
                        const memberName = loan.first_name && loan.last_name ? `${loan.first_name} ${loan.last_name}` : 'Unknown';
                        const loanType = loan.loan_type || 'unknown';
                        const loanTypeDisplay = loanType === 'rapid' ? '<span style="color: #ff6b6b;"><i class="fas fa-bolt"></i> Rapid (30 days)</span>' : '<span style="color: #4ecdc4;"><i class="fas fa-hourglass"></i> Long (Cycle)</span>';
                        const durationDays = loan.duration_days || 30;
                        const requestedDate = new Date(loan.requested_date).toLocaleDateString();
                        
                        html += `
                            <tr style="border-bottom: 1px solid #eee;">
                                <td style="padding: 12px;">${memberName}</td>
                                <td style="padding: 12px;">${loanTypeDisplay}</td>
                                <td style="padding: 12px; font-weight: 600;">${(loan.amount || 0).toLocaleString('en-RW')}</td>
                                <td style="padding: 12px;">${durationDays} days</td>
                                <td style="padding: 12px;">${requestedDate}</td>
                                <td style="padding: 12px;">
                                    <button class="action-btn approve" onclick="openLoanApprovalReceiptModal('${loan.id}', '${loanType}', ${loan.amount}); return false;" style="margin-right: 5px;"><i class="fas fa-check"></i> Approve</button>
                                    <button class="action-btn delete" onclick="rejectLoan('${loan.id}'); return false;"><i class="fas fa-times"></i> Reject</button>
                                </td>
                            </tr>`;
                    });
                }
                
                html += `</tbody></table>`;
                document.getElementById('loansListContent').innerHTML = html;
            })
            .catch(error => {
                console.error('Error loading loans under review:', error);
                document.getElementById('loansListContent').innerHTML = `<p style="text-align: center; color: var(--danger);"><i class="fas fa-exclamation-circle"></i> Error loading loans: ${error.message}</p>`;
            });
        }

        // Open receipt upload modal for loan approval
        function openLoanApprovalReceiptModal(loanId, loanType, loanAmount) {
            document.getElementById('loanApprovalLoanId').value = loanId;
            document.getElementById('loanApprovalLoanType').value = loanType;
            document.getElementById('loanApprovalAmount').value = loanAmount;
            document.getElementById('loanApprovalReceiptModal').classList.add('active');
        }

        function closeLoanApprovalReceiptModal() {
            document.getElementById('loanApprovalReceiptModal').classList.remove('active');
            document.getElementById('loanApprovalReceiptForm').reset();
        }

        // Submit receipt and then approve loan
        async function submitLoanApprovalReceipt() {
            try {
                const loanId = document.getElementById('loanApprovalLoanId').value;
                const loanType = document.getElementById('loanApprovalLoanType').value;
                const transactionDate = document.getElementById('loanApprovalTransactionDate').value;
                const receiptFile = document.getElementById('loanApprovalReceiptFile').files[0];

                if (!transactionDate) {
                    alert('Please select a transaction date');
                    return;
                }

                if (!receiptFile) {
                    alert('Please upload a receipt file');
                    return;
                }

                // Find the submit button properly
                const submitBtn = document.querySelector('#loanApprovalReceiptModal .btn-primary');
                if (submitBtn) {
                    submitBtn.disabled = true;
                    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
                }

                const token = localStorage.getItem('authToken') || localStorage.getItem('token');
                
                // Read the file and convert to base64
                const reader = new FileReader();
                reader.onload = async function(e) {
                    try {
                        const fileData = e.target.result;
                        
                        // Approve the loan with receipt information
                        const approveResponse = await fetch(`${API_CONFIG.BASE_URL}/loans/${loanId}/approve`, {
                            method: 'POST',
                            headers: {
                                'Authorization': `Bearer ${token}`,
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({ 
                                approvedAt: new Date().toISOString(),
                                transaction_date: transactionDate,
                                receipt_file: fileData,
                                receipt_filename: receiptFile.name,
                                receipt_uploaded: true
                            })
                        });

                        if (!approveResponse.ok) {
                            const errorData = await approveResponse.json();
                            throw new Error(errorData.message || 'Failed to approve loan');
                        }

                        alert('Loan approved successfully and receipt recorded!');
                        closeLoanApprovalReceiptModal();
                        
                        // Reload the appropriate loans list
                        if (loanType === 'rapid') loadRapidLoans();
                        else if (loanType === 'long') loadLongLoans();
                        else loadUnderReviewLoans();

                    } catch (error) {
                        console.error('Error in loan approval:', error);
                        alert('Error: ' + error.message);
                    } finally {
                        // Always reset the button state
                        const submitBtn = document.querySelector('#loanApprovalReceiptModal .btn-primary');
                        if (submitBtn) {
                            submitBtn.disabled = false;
                            submitBtn.innerHTML = '<i class="fas fa-check"></i> Approve with Receipt';
                        }
                    }
                };
                
                // Handle file read errors
                reader.onerror = function() {
                    alert('Error reading file. Please try again.');
                    const submitBtn = document.querySelector('#loanApprovalReceiptModal .btn-primary');
                    if (submitBtn) {
                        submitBtn.disabled = false;
                        submitBtn.innerHTML = '<i class="fas fa-check"></i> Approve with Receipt';
                    }
                };
                
                reader.readAsDataURL(receiptFile);

            } catch (error) {
                console.error('Error in loan approval:', error);
                alert('Error: ' + error.message);
                const submitBtn = document.querySelector('#loanApprovalReceiptModal .btn-primary');
                if (submitBtn) {
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = '<i class="fas fa-check"></i> Approve with Receipt';
                }
            }
        }

        function approveLoan(loanId, loanType) {
            if (!confirm('Are you sure you want to approve this loan?')) return;
            
            const authToken = localStorage.getItem('authToken');
            if (!authToken) {
                alert('Session expired. Please login again.');
                return;
            }

            fetch(`${API_CONFIG.BASE_URL}/loans/${loanId}/approve`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${authToken}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ approvedAt: new Date().toISOString() })
            })
            .then(response => {
                if (!response.ok) throw new Error('Failed to approve loan');
                return response.json();
            })
            .then(data => {
                alert('Loan approved successfully!');
                // Reload the appropriate loans list
                if (loanType === 'rapid') loadRapidLoans();
                else if (loanType === 'long') loadLongLoans();
                else loadUnderReviewLoans();
            })
            .catch(error => {
                console.error('Error approving loan:', error);
                alert(`Error approving loan: ${error.message}`);
            });
        }

        function rejectLoan(loanId) {
            if (!confirm('Are you sure you want to reject this loan?')) return;
            
            const authToken = localStorage.getItem('authToken');
            if (!authToken) {
                alert('Session expired. Please login again.');
                return;
            }

            fetch(`${API_CONFIG.BASE_URL}/loans/${loanId}/reject`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${authToken}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ rejectedAt: new Date().toISOString() })
            })
            .then(response => {
                if (!response.ok) throw new Error('Failed to reject loan');
                return response.json();
            })
            .then(data => {
                alert('Loan rejected successfully!');
                loadUnderReviewLoans();
            })
            .catch(error => {
                console.error('Error rejecting loan:', error);
                alert(`Error rejecting loan: ${error.message}`);
            });
        }

        function markLoanAsRepaid(loanId) {
            if (!confirm('Mark this loan as repaid?')) return;
            
            const authToken = localStorage.getItem('authToken');
            if (!authToken) {
                alert('Session expired. Please login again.');
                return;
            }

            fetch(`${API_CONFIG.BASE_URL}/loans/${loanId}/repay`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${authToken}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ repaidAt: new Date().toISOString() })
            })
            .then(response => {
                if (!response.ok) throw new Error('Failed to mark loan as repaid');
                return response.json();
            })
            .then(data => {
                alert('Loan marked as repaid!');
                loadConfirmedLoans();
            })
            .catch(error => {
                console.error('Error marking loan as repaid:', error);
                alert(`Error marking loan as repaid: ${error.message}`);
            });
        }

        function loadPaidLoans() {
            const authToken = localStorage.getItem('authToken');
            let userGroup = localStorage.getItem('userGroup') || currentGroupId;
            
            if (!authToken || !userGroup) {
                console.error('Missing auth token or user group');
                return;
            }

            fetch(`${API_CONFIG.BASE_URL}/loans?groupId=${userGroup}`, {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${authToken}`,
                    'Content-Type': 'application/json'
                }
            })
            .then(response => {
                if (!response.ok) throw new Error('Failed to load paid loans');
                return response.json();
            })
            .then(data => {
                const allLoans = Array.isArray(data) ? data : (data.data || []);
                // Filter for repaid loans only
                const paidLoans = allLoans.filter(l => l.status === 'repaid');
                
                // Update table
                const tableBody = document.getElementById('paidLoansTableBody');
                let html = '';
                
                if (paidLoans.length === 0) {
                    html = `<tr><td colspan="6" style="padding: 20px; text-align: center; color: #999;">No paid loans yet</td></tr>`;
                } else {
                    paidLoans.forEach(loan => {
                        const memberName = loan.first_name && loan.last_name ? `${loan.first_name} ${loan.last_name}` : 'Unknown';
                        const loanType = loan.loan_type || 'unknown';
                        const loanTypeDisplay = loanType === 'rapid' ? 'Rapid Loan' : (loanType === 'standard' ? 'Standard Loan' : 'Emergency Loan');
                        const amount = loan.amount ? loan.amount.toLocaleString('en-RW') : '0';
                        const repaidDate = loan.repaid_date ? new Date(loan.repaid_date).toLocaleDateString() : 'N/A';
                        
                        html += `
                            <tr>
                                <td>${memberName}</td>
                                <td>${loanTypeDisplay}</td>
                                <td>${amount} RWF</td>
                                <td>${repaidDate}</td>
                                <td><span class="status-badge" style="background: #d4edda; color: #155724;">Paid</span></td>
                                <td>
                                    <button class="action-btn" style="padding: 6px 12px; background: #0066cc; color: white; border: none; border-radius: 4px; cursor: pointer;" onclick="viewLoanDetails('${loan.id}')">View</button>
                                </td>
                            </tr>
                        `;
                    });
                }
                
                tableBody.innerHTML = html;
            })
            .catch(error => {
                console.error('Error loading paid loans:', error);
                const tableBody = document.getElementById('paidLoansTableBody');
                tableBody.innerHTML = `<tr><td colspan="6" style="padding: 20px; text-align: center; color: #999;">Error loading paid loans</td></tr>`;
            });
        }

        function loadContributionSummary() {
            const authToken = localStorage.getItem('authToken');
            let userGroup = localStorage.getItem('userGroup') || currentGroupId;
            
            if (!authToken || !userGroup) {
                console.error('Missing auth token or user group');
                document.getElementById('contributionSummaryTableBody').innerHTML = `<tr><td colspan="4" style="padding: 20px; text-align: center; color: #999;">Missing authentication or group information</td></tr>`;
                return;
            }

            console.log('Loading contribution summary for group:', userGroup);

            // Use the same successful approach as loadActiveMembers
            Promise.all([
                GroupsAPI.getActiveMembers(userGroup),
                fetch(`${API_CONFIG.BASE_URL}/loans`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    }
                }).then(r => {
                    console.log('Loans response status:', r.status);
                    if (!r.ok) throw new Error(`Loans API failed: ${r.status}`);
                    return r.json();
                }).catch(err => {
                    console.warn('Loans endpoint failed, using empty array:', err);
                    return [];
                })
            ])
            .then(([membersResponse, loansData]) => {
                console.log('Members Response:', membersResponse);
                console.log('Loans Data:', loansData);

                // Extract members from response - handle the structure returned by getActiveMembers
                let members = [];
                if (membersResponse) {
                    // getActiveMembers returns {members: Array} based on what we saw in loadActiveMembers
                    members = Array.isArray(membersResponse) ? membersResponse : 
                               (membersResponse.members || membersResponse.data || []);
                }

                let loans = Array.isArray(loansData) ? loansData : (loansData.data || loansData.loans || []);
                
                // Filter loans by group ID
                loans = loans.filter(l => l.group_id === userGroup);

                console.log('Final members:', members);
                console.log('Final loans (filtered):', loans);

                // Calculate totals per member
                const memberSummary = {};
                
                // Initialize all members with their total_contributions from the member object
                members.forEach(member => {
                    const userId = member.user_id || member.id;
                    // Use the total_contributions that's already calculated on the member
                    const memberContributions = Number(member.total_contributions) || 0;
                    console.log(`📊 ${member.first_name} ${member.last_name}: contributions=${memberContributions}`);
                    
                    memberSummary[userId] = {
                        name: (member.first_name && member.last_name) ? `${member.first_name} ${member.last_name}` : 'Unknown',
                        contributions: memberContributions,
                        loans: 0
                    };
                });

                console.log('Initialized member summary:', memberSummary);

                // Sum loans per member
                loans.forEach(loan => {
                    if (loan.status !== 'rejected' && memberSummary[loan.borrower_id]) {
                        const loanAmount = Number(loan.amount) || 0;
                        memberSummary[loan.borrower_id].loans += loanAmount;
                        console.log(`💰 Added loan ${loanAmount} to ${memberSummary[loan.borrower_id].name}`);
                    }
                });

                console.log('Final member summary:', memberSummary);

                // Build table rows
                const tableBody = document.getElementById('contributionSummaryTableBody');
                let html = '';
                let totalContributions = 0;
                let totalLoans = 0;

                const memberEntries = Object.entries(memberSummary);
                if (memberEntries.length === 0) {
                    html = `<tr><td colspan="4" style="padding: 20px; text-align: center; color: #999;">No members found</td></tr>`;
                } else {
                    memberEntries.forEach(([userId, data]) => {
                        const netContribution = data.contributions - data.loans;
                        const netColor = netContribution < 0 ? '#ff4444' : '#00c851';
                        
                        html += `
                            <tr>
                                <td style="padding: 12px;">${data.name}</td>
                                <td style="padding: 12px; text-align: right;">${data.contributions.toLocaleString('en-RW')}</td>
                                <td style="padding: 12px; text-align: right;">${data.loans.toLocaleString('en-RW')}</td>
                                <td style="padding: 12px; text-align: right; color: ${netColor}; font-weight: bold;">${netContribution.toLocaleString('en-RW')}</td>
                            </tr>
                        `;
                        
                        totalContributions += data.contributions;
                        totalLoans += data.loans;
                    });
                }

                tableBody.innerHTML = html;

                // Update footer totals
                const netTotal = totalContributions - totalLoans;
                const netColor = netTotal < 0 ? '#ff4444' : '#00c851';

                document.getElementById('totalContribution').textContent = totalContributions.toLocaleString('en-RW') + ' RWF';
                document.getElementById('totalLoans').textContent = totalLoans.toLocaleString('en-RW') + ' RWF';
                
                const totalNetElement = document.getElementById('totalNetContribution');
                totalNetElement.textContent = netTotal.toLocaleString('en-RW') + ' RWF';
                totalNetElement.style.color = netColor;

                console.log('✅ Contribution summary loaded successfully');
            })
            .catch(error => {
                console.error('Error loading contribution summary:', error);
                const tableBody = document.getElementById('contributionSummaryTableBody');
                tableBody.innerHTML = `<tr><td colspan="4" style="padding: 20px; text-align: center; color: #999;">Error loading data: ${error.message}</td></tr>`;
            });
        }


        // Attach edit and delete button listeners
        document.addEventListener('DOMContentLoaded', function() {
            attachMemberActionListeners();
        });

        function attachMemberActionListeners() {
            // Edit buttons
            document.querySelectorAll('.action-btn.edit').forEach(button => {
                button.addEventListener('click', function() {
                    const row = this.closest('tr');
                    const memberName = row.cells[0].textContent;
                    const joinDate = row.cells[1].textContent;
                    // Email format generated from name
                    const memberEmail = memberName.toLowerCase().replace(/\s+/g, '.') + '@email.com';
                    const memberPhone = '+250 78 XXX XXXX';
                    
                    openEditMemberModal(memberName, memberEmail, memberPhone, 'Member', '', '', 'active', '');
                });
            });

            // Delete buttons
            document.querySelectorAll('.action-btn.delete').forEach(button => {
                button.addEventListener('click', function() {
                    const row = this.closest('tr');
                    const memberName = row.cells[0].textContent;
                    openDeleteMemberModal(memberName);
                });
            });
        }

        // Close modal when clicking outside of it
        window.addEventListener('click', function(event) {
            const editModal = document.getElementById('editMemberModal');
            const deleteModal = document.getElementById('deleteMemberModal');
            const paymentModal = document.getElementById('paymentApprovalModal');
            
            if (event.target === editModal) {
                closeModal('editMemberModal');
            }
            if (event.target === deleteModal) {
                closeModal('deleteMemberModal');
            }
            if (event.target === paymentModal) {
                closeModal('paymentApprovalModal');
            }
        });
        
        // Payment Request Functions
        let currentPaymentId = null;
        let currentPaymentAmount = null;
        
        function openPaymentApprovalModal(paymentId, memberName, amount, method, receiptUrl) {
            currentPaymentId = paymentId;
            currentPaymentAmount = amount;
            document.getElementById('paymentMemberName').textContent = memberName;
            document.getElementById('paymentAmount').textContent = amount.toLocaleString() + ' RWF';
            document.getElementById('paymentMethod').textContent = method;
            
            // Set up the receipt link if available
            const receiptLink = document.getElementById('paymentReceiptLink');
            if (receiptUrl && receiptUrl.startsWith('data:')) {
                receiptLink.onclick = function() {
                    openReceiptPreview(receiptUrl);
                };
                receiptLink.style.cursor = 'pointer';
            }
            
            openModal('paymentApprovalModal');
        }
        
        function openReceiptPreview(receiptUrl) {
            const modal = document.createElement('div');
            modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center; z-index: 10000;';
            modal.onclick = function() { this.remove(); };
            
            const content = document.createElement('div');
            content.style.cssText = 'background: white; padding: 20px; border-radius: 8px; max-width: 90%; max-height: 90%; overflow: auto;';
            
            if (receiptUrl.startsWith('data:image')) {
                const img = document.createElement('img');
                img.src = receiptUrl;
                img.style.maxWidth = '100%';
                content.appendChild(img);
            } else {
                content.innerHTML = '<p>Receipt file: ' + receiptUrl + '</p>';
            }
            
            modal.appendChild(content);
            document.body.appendChild(modal);
        }
        
        function approvePayment() {
            if (!currentPaymentId) return;
            
            const approveBtn = document.querySelector('#paymentApprovalModal .btn-success');
            approveBtn.disabled = true;
            approveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Approving...';
            
            fetch('http://localhost:5000/api/payments/requests/' + currentPaymentId + '/approve', {
                method: 'POST',
                headers: {
                    'Authorization': 'Bearer ' + localStorage.getItem('authToken'),
                    'Content-Type': 'application/json'
                }
            })
            .then(response => {
                if (!response.ok) throw new Error('Failed to approve payment');
                return response.json();
            })
            .then(data => {
                alert('Payment request approved successfully!');
                closeModal('paymentApprovalModal');
                loadPaymentRequests(); // Refresh the payment requests list
                loadTransactions(); // Refresh the transactions list
                loadLeaderContribution(); // Refresh the leader's contribution
            })
            .catch(error => {
                alert('Error approving payment: ' + error.message);
                approveBtn.disabled = false;
                approveBtn.innerHTML = '<i class="fas fa-check"></i> Approve';
            });
        }
        
        function rejectPayment() {
            if (!currentPaymentId) return;
            
            const reason = prompt('Enter reason for rejection:');
            if (!reason) return;
            
            const rejectBtn = document.querySelector('#paymentApprovalModal .btn-danger');
            rejectBtn.disabled = true;
            rejectBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Rejecting...';
            
            fetch('http://localhost:5000/api/payments/requests/' + currentPaymentId + '/reject', {
                method: 'POST',
                headers: {
                    'Authorization': 'Bearer ' + localStorage.getItem('authToken'),
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ reason: reason })
            })
            .then(response => {
                if (!response.ok) throw new Error('Failed to reject payment');
                return response.json();
            })
            .then(data => {
                alert('Payment request rejected.');
                closeModal('paymentApprovalModal');
                loadPaymentRequests(); // Refresh the list
            })
            .catch(error => {
                alert('Error rejecting payment: ' + error.message);
                rejectBtn.disabled = false;
                rejectBtn.innerHTML = '<i class="fas fa-times"></i> Reject';
            });
        }
        
        // Load leader's total contribution
        function loadLeaderContribution() {
            const user = TokenManager.getUser();
            if (!user) {
                console.warn('No user found for contribution');
                return;
            }
            
            let groupId = window.currentGroupId || currentGroupId;
            
            // If still no groupId, fetch it from the user's led groups
            if (!groupId) {
                console.log('No groupId for contribution, fetching from API...');
                
                // Fetch all groups to find ones where user is leader
                fetch('http://localhost:5000/api/groups', {
                    headers: {
                        'Authorization': 'Bearer ' + localStorage.getItem('authToken')
                    }
                })
                .then(response => {
                    if (!response.ok) throw new Error('Failed to fetch groups');
                    return response.json();
                })
                .then(data => {
                    const groups = data.groups || data || [];
                    const leaderGroups = groups.filter(g => g.leader_id === user.id);
                    
                    if (leaderGroups.length === 0) {
                        console.log('No groups found for user');
                        return;
                    }
                    
                    currentGroupId = leaderGroups[0].id;
                    window.currentGroupId = leaderGroups[0].id;
                    console.log('Set groupId for contribution to:', currentGroupId);
                    
                    // Now load the contribution with the group ID
                    loadLeaderContributionForGroup(currentGroupId, user);
                })
                .catch(error => {
                    console.error('Error fetching groups:', error);
                    document.getElementById('totalContributionAmount').textContent = 'Error';
                    document.getElementById('lastContributionText').textContent = 'Last contribution: Error loading';
                });
                
                return;
            }
            
            loadLeaderContributionForGroup(groupId, user);
        }
        
        function loadLeaderContributionForGroup(groupId, user) {
            console.log('Loading leader contribution for group:', groupId, 'user:', user.id);
            
            fetch('http://localhost:5000/api/contributions?groupId=' + groupId, {
                headers: {
                    'Authorization': 'Bearer ' + localStorage.getItem('authToken')
                }
            })
            .then(response => {
                if (!response.ok) throw new Error('Failed to load contribution');
                return response.json();
            })
            .then(data => {
                console.log('Leader contribution data:', data);
                
                // Handle different response formats
                let contributions = [];
                if (Array.isArray(data)) {
                    contributions = data;
                } else if (data && data.contributions) {
                    contributions = data.contributions;
                } else if (data && data.data) {
                    contributions = data.data;
                }
                
                console.log('Total contributions found:', contributions.length);
                console.log('Current user:', user);
                
                // Filter for current user's contributions - try multiple matching strategies
                let userContributions = contributions.filter(c => {
                    // Try matching by user_id
                    if (c.user_id === user.id) return true;
                    // Try matching by name
                    if (c.first_name && c.last_name && user.first_name && user.last_name) {
                        if (c.first_name.toLowerCase() === user.first_name.toLowerCase() && 
                            c.last_name.toLowerCase() === user.last_name.toLowerCase()) {
                            return true;
                        }
                    }
                    // Try matching by email
                    if (c.email && user.email && c.email.toLowerCase() === user.email.toLowerCase()) {
                        return true;
                    }
                    return false;
                });
                
                // If no exact match found, show all contributions (for debugging)
                if (userContributions.length === 0) {
                    console.log('No user-specific contributions found, showing all contributions for group');
                    userContributions = contributions;
                }
                
                console.log('User contributions found:', userContributions.length, userContributions);
                
                if (userContributions.length === 0) {
                    document.getElementById('totalContributionAmount').textContent = '0 RWF';
                    document.getElementById('lastContributionText').textContent = 'Last contribution: No contributions yet';
                    return;
                }
                
                // Calculate total
                const total = userContributions.reduce((sum, c) => sum + (c.amount || 0), 0);
                console.log('Total amount calculated:', total);
                
                // Get latest contribution date
                const latestContribution = userContributions.sort((a, b) => 
                    new Date(b.created_at || 0) - new Date(a.created_at || 0)
                )[0];
                
                const lastDate = latestContribution.created_at 
                    ? new Date(latestContribution.created_at).toLocaleDateString() 
                    : 'Unknown';
                
                console.log('Last contribution date:', lastDate);
                
                document.getElementById('totalContributionAmount').textContent = total.toLocaleString() + ' RWF';
                document.getElementById('lastContributionText').textContent = 'Last contribution: ' + lastDate;
            })
            .catch(error => {
                console.error('Error loading leader contribution:', error);
                document.getElementById('totalContributionAmount').textContent = 'Error';
                document.getElementById('lastContributionText').textContent = 'Last contribution: Error loading';
            });
        }
        
        // Load recent transactions
        function loadTransactions() {
            // Show loading state
            const tbody = document.getElementById('transactionsTableBody');
            tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 40px; color: var(--gray);"><i class="fas fa-spinner fa-spin" style="font-size: 36px; margin-bottom: 10px;"></i><p>Loading transactions...</p></td></tr>';
            
            let groupId = window.currentGroupId || currentGroupId;
            console.log('loadTransactions - Initial groupId:', groupId);
            
            if (!groupId) {
                console.log('No groupId for transactions, attempting to fetch from API...');
                
                const user = TokenManager.getUser();
                if (!user) {
                    const tbody = document.getElementById('transactionsTableBody');
                    tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 40px; color: var(--warning);">Please log in to view transactions.</td></tr>';
                    return;
                }
                
                // Fetch all groups to find ones where user is leader
                fetch('http://localhost:5000/api/groups', {
                    headers: {
                        'Authorization': 'Bearer ' + localStorage.getItem('authToken')
                    }
                })
                .then(response => {
                    if (!response.ok) throw new Error('Failed to fetch groups');
                    return response.json();
                })
                .then(data => {
                    const groups = data.groups || data || [];
                    const leaderGroups = groups.filter(g => g.leader_id === user.id);
                    
                    if (leaderGroups.length === 0) {
                        const tbody = document.getElementById('transactionsTableBody');
                        tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 40px; color: var(--warning);">You are not leading any group.</td></tr>';
                        return;
                    }
                    
                    currentGroupId = leaderGroups[0].id;
                    window.currentGroupId = leaderGroups[0].id;
                    
                    loadTransactionsForGroup(currentGroupId);
                })
                .catch(error => {
                    console.error('Error fetching groups:', error);
                    const tbody = document.getElementById('transactionsTableBody');
                    tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 40px; color: var(--danger);">Error loading transactions</td></tr>';
                });
                
                return;
            }
            
            loadTransactionsForGroup(groupId);
        }
        
        function loadTransactionsForGroup(groupId) {
            console.log('Loading transactions for group:', groupId);
            
            // Fetch both contributions AND approved payments
            Promise.all([
                // Fetch contributions
                fetch('http://localhost:5000/api/contributions?groupId=' + groupId, {
                    headers: {
                        'Authorization': 'Bearer ' + localStorage.getItem('authToken')
                    }
                }),
                // Also fetch approved payments
                fetch('http://localhost:5000/api/payments/requests?groupId=' + groupId + '&status=approved', {
                    headers: {
                        'Authorization': 'Bearer ' + localStorage.getItem('authToken')
                    }
                })
            ])
            .then(async responses => {
                const [contribResponse, paymentResponse] = responses;
                console.log('Contributions response status:', contribResponse.status);
                console.log('Approved payments response status:', paymentResponse.status);
                
                let contributions = [];
                let approvedPayments = [];
                
                // Handle contributions
                if (contribResponse.status === 401) {
                    throw new Error('Unauthorized. Please log in again.');
                }
                if (contribResponse.ok) {
                    const contribData = await contribResponse.json();
                    if (Array.isArray(contribData)) {
                        contributions = contribData;
                    } else if (contribData && contribData.contributions) {
                        contributions = contribData.contributions;
                    } else if (contribData && contribData.data) {
                        contributions = contribData.data;
                    }
                    console.log('Contributions fetched:', contributions.length);
                }
                
                // Handle approved payments
                if (paymentResponse.ok) {
                    const paymentData = await paymentResponse.json();
                    if (Array.isArray(paymentData)) {
                        approvedPayments = paymentData;
                    } else if (paymentData && paymentData.payments) {
                        approvedPayments = paymentData.payments;
                    } else if (paymentData && paymentData.data) {
                        approvedPayments = paymentData.data;
                    }
                    console.log('Approved payments fetched:', approvedPayments.length);
                }
                
                return { contributions, approvedPayments };
            })
            .then(({ contributions, approvedPayments }) => {
                const tbody = document.getElementById('transactionsTableBody');
                
                // Merge contributions and approved payments
                let allTransactions = [];
                
                // Add contributions
                if (contributions && contributions.length > 0) {
                    allTransactions = allTransactions.concat(contributions);
                }
                
                // Add approved payments (they should have become contributions, but show them anyway)
                if (approvedPayments && approvedPayments.length > 0) {
                    allTransactions = allTransactions.concat(approvedPayments.map(p => ({
                        id: p.id,
                        amount: p.amount,
                        payment_method: p.payment_method,
                        first_name: p.first_name,
                        last_name: p.last_name,
                        created_at: p.created_at || p.approved_at,
                        status: 'approved'
                    })));
                }
                
                console.log('Total transactions (merged):', allTransactions.length);
                
                if (!allTransactions || allTransactions.length === 0) {
                    console.log('No transactions found, showing empty state');
                    tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 40px; color: var(--gray);"><i class="fas fa-inbox" style="font-size: 36px; margin-bottom: 10px;"></i><p>No transactions yet</p></td></tr>';
                    return;
                }
                
                // Sort by date, newest first
                allTransactions.sort((a, b) => {
                    const dateA = new Date(a.created_at || 0);
                    const dateB = new Date(b.created_at || 0);
                    return dateB - dateA;
                });
                
                // Remove duplicates (same payment might appear in both lists)
                const uniqueTransactions = [];
                const seenIds = new Set();
                for (const t of allTransactions) {
                    if (!seenIds.has(t.id)) {
                        uniqueTransactions.push(t);
                        seenIds.add(t.id);
                    }
                }
                
                // Show only last 10 transactions
                const recentTransactions = uniqueTransactions.slice(0, 10);
                
                tbody.innerHTML = recentTransactions.map(transaction => {
                    const date = new Date(transaction.created_at || Date.now()).toLocaleDateString();
                    const amount = (transaction.amount || 0).toLocaleString() + ' RWF';
                    const statusBadge = transaction.status === 'approved' 
                        ? '<span class="status-badge status-active">Completed</span>'
                        : '<span class="status-badge status-pending">Pending</span>';
                    const memberName = `${transaction.first_name || transaction.member_name || 'User'} ${transaction.last_name || ''}`.trim();
                    const paymentMethod = transaction.payment_method 
                        ? transaction.payment_method.charAt(0).toUpperCase() + transaction.payment_method.slice(1) 
                        : 'Contribution';
                    
                    return `
                        <tr>
                            <td>${date}</td>
                            <td>${memberName}</td>
                            <td>${paymentMethod}</td>
                            <td>${amount}</td>
                            <td>${statusBadge}</td>
                        </tr>
                    `;
                }).join('');
                console.log('Rendered', recentTransactions.length, 'transactions');
                
                // Load leader's contribution after transactions are loaded
                loadLeaderContribution();
            })
            .catch(error => {
                console.error('Error loading transactions:', error);
                const tbody = document.getElementById('transactionsTableBody');
                tbody.innerHTML = `<tr><td colspan="5" style="text-align: center; padding: 40px; color: var(--danger);"><i class="fas fa-exclamation-circle" style="font-size: 36px; margin-bottom: 10px;"></i><p>Error: ${error.message}</p><p style="font-size: 0.85rem; margin-top: 10px;">Check console for details</p></td></tr>`;
            });
        }
        
        function loadPaymentRequests() {
            // Show loading state
            const tbody = document.getElementById('paymentRequestsTableBody');
            tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 40px; color: var(--gray);"><i class="fas fa-spinner fa-spin" style="font-size: 36px; margin-bottom: 10px;"></i><p>Loading payment requests...</p></td></tr>';
            
            let groupId = window.currentGroupId || currentGroupId;
            console.log('loadPaymentRequests - Initial groupId:', groupId);
            
            // If still no groupId, fetch it from the user's led groups
            if (!groupId) {
                console.log('No groupId found locally, fetching from API...');
                
                const user = TokenManager.getUser();
                if (!user) {
                    console.warn('No user found');
                    const tbody = document.getElementById('paymentRequestsTableBody');
                    tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 40px; color: var(--warning);"><i class="fas fa-exclamation-triangle" style="font-size: 36px; margin-bottom: 10px;"></i><p>Please log in to view payment requests.</p></td></tr>';
                    return;
                }
                
                // Fetch all groups to find ones where user is leader
                fetch('http://localhost:5000/api/groups', {
                    headers: {
                        'Authorization': 'Bearer ' + localStorage.getItem('authToken')
                    }
                })
                .then(response => {
                    if (!response.ok) throw new Error('Failed to fetch groups');
                    return response.json();
                })
                .then(data => {
                    console.log('Groups API response:', data);
                    
                    const groups = data.groups || data || [];
                    const leaderGroups = groups.filter(g => g.leader_id === user.id);
                    
                    console.log('Leader groups found:', leaderGroups.length);
                    
                    if (leaderGroups.length === 0) {
                        const tbody = document.getElementById('paymentRequestsTableBody');
                        tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 40px; color: var(--warning);"><i class="fas fa-exclamation-triangle" style="font-size: 36px; margin-bottom: 10px;"></i><p>You are not leading any group.</p></td></tr>';
                        return;
                    }
                    
                    currentGroupId = leaderGroups[0].id;
                    window.currentGroupId = leaderGroups[0].id;
                    console.log('Set groupId to:', currentGroupId);
                    
                    // Now load payment requests with the group ID
                    loadPaymentRequestsForGroup(currentGroupId);
                })
                .catch(error => {
                    console.error('Error fetching groups:', error);
                    const tbody = document.getElementById('paymentRequestsTableBody');
                    tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 40px; color: var(--danger);"><i class="fas fa-exclamation-circle" style="font-size: 36px; margin-bottom: 10px;"></i><p>Error: ' + error.message + '</p></td></tr>';
                });
                
                return;
            }
            
            loadPaymentRequestsForGroup(groupId);
        }
        
        function loadPaymentRequestsForGroup(groupId) {
            console.log('Loading payment requests for group:', groupId);
            
            fetch('http://localhost:5000/api/payments/requests?groupId=' + groupId + '&status=pending', {
                headers: {
                    'Authorization': 'Bearer ' + localStorage.getItem('authToken')
                }
            })
            .then(response => {
                console.log('Payment requests response:', response.status);
                if (response.status === 401) {
                    throw new Error('Unauthorized. Please log in again.');
                }
                if (!response.ok) {
                    return response.json().then(err => {
                        throw new Error(err.error || err.message || 'Failed to load payment requests');
                    });
                }
                return response.json();
            })
            .then(data => {
                const tbody = document.getElementById('paymentRequestsTableBody');
                const count = document.getElementById('paymentRequestCount');
                
                if (!data || data.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 40px; color: var(--gray);"><i class="fas fa-check-circle" style="font-size: 36px; margin-bottom: 10px; color: var(--success);"></i><p>No pending payment requests</p></td></tr>';
                    count.textContent = '0';
                    return;
                }
                
                count.textContent = data.length;
                tbody.innerHTML = data.map(payment => {
                    const methodEmoji = { mobile: '📱', bank: '🏦', cash: '💵' }[payment.payment_method] || '💳';
                    const statusBadge = `<span class="status-badge status-pending">Pending</span>`;
                    
                    return `
                        <tr>
                            <td>${payment.first_name} ${payment.last_name}</td>
                            <td>${payment.amount.toLocaleString()} RWF</td>
                            <td>${methodEmoji} ${payment.payment_method}</td>
                            <td><a href="#" onclick="openReceiptPreview('${payment.receipt_url}'); return false;" style="color: var(--primary);">View</a></td>
                            <td>${new Date(payment.created_at).toLocaleDateString()}</td>
                            <td>${statusBadge}</td>
                            <td>
                                <button class="action-btn approve" onclick="openPaymentApprovalModal('${payment.id}', '${payment.first_name} ${payment.last_name}', ${payment.amount}, '${payment.payment_method}', '${payment.receipt_url}'); return false;">
                                    <i class="fas fa-check"></i> Approve
                                </button>
                            </td>
                        </tr>
                    `;
                }).join('');
            })
            .catch(error => {
                console.error('Error loading payment requests:', error);
                const tbody = document.getElementById('paymentRequestsTableBody');
                const errorMsg = error.message || 'Error loading payment requests';
                tbody.innerHTML = `<tr><td colspan="7" style="text-align: center; padding: 40px; color: var(--danger);"><i class="fas fa-exclamation-circle" style="font-size: 36px; margin-bottom: 10px;"></i><p>${errorMsg}</p><p style="font-size: 0.85rem; margin-top: 10px;">Check browser console for details.</p></td></tr>`;
            });
        }
        
        // Load payment requests and transactions on page load
        document.addEventListener('DOMContentLoaded', function() {
            attachMemberActionListeners();
            loadPaymentRequests();
            loadTransactions(); // This now calls loadLeaderContribution at the end
        });
    </script>
</body>
</html>